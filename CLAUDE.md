# Claude Code 開発ルール

## 絶対的ルール（確定事項）

### 1. 推測禁止ルール
- **推測での対応は絶対禁止**
- エラーや問題が発生した場合は必ず最新情報を調査する
- 時間がかかっても正確な情報を確認してから対応する
- 調査結果は必ずmemoryとCLAUDE.mdの両方に記録する
- 「〜だと思います」「〜の可能性があります」ではなく、調査して事実を確認する

### 2. テスト必須ルール
- **コードを書いたら必ずテストする**
- コミット前に必ず動作確認を行う
- 「先にチェックした？」と聞かれないように、常に事前テストを実施
- テストなしでのコミットは絶対禁止
- PlaywrightやcURLでの実動作確認を優先

### 3. データベース操作ルール
- **access_rightsなど重要テーブルの更新は必ず確認**
- INSERTやUPDATEを行ったら、実際にデータが入っているか確認
- 「これ作成されてなくね？」と指摘される前に、必ずDBの状態を確認
- Supabaseダッシュボードまたはクエリで実データを確認

### 4. ファイル編集ルール
- **ファイルを編集する前に必ずReadツールで読む**
- 存在しないファイルにWriteしようとしない
- 既存ファイルの編集を優先し、新規ファイル作成は最小限に
- プロジェクトの既存パターンに従う

### 5. URLとリンクの正確性
- **診断結果URLなど、重要なリンクは何度も確認**
- 「だからリンクこれじゃねえっていってんだろ」と言われないよう、正確なURLを使用
- `/lp-otsukisama-unified.html` が正しい診断結果ページ
- URLパラメータ（id, userId）の引き継ぎを確実に行う

### 6. API整理ルール
- **使用していないAPIファイルは削除または整理**
- 「api/main.js - 未使用 → 本当に未使用ですか」の確認を怠らない
- 削除前に依存関係を必ず確認
- Vercelの関数制限（Hobbyプラン12個）を意識

### 7. 環境変数と設定
- **本番環境とサンドボックス環境の違いを明確に理解**
- 環境変数の値をハードコードしない（既存のハードコードは除く）
- .env.localの内容を正確に把握

### 8. エラーハンドリング
- **エラーが発生した場合、ユーザーに分かりやすく伝える**
- 技術的なエラーメッセージをそのまま表示しない
- 解決方法やガイドへの誘導を提供

### 9. コミットメッセージ
- **何を修正したか明確に記載**
- 問題の原因と解決方法を含める
- 日本語で分かりやすく書く

### 10. 調査手順
1. エラーが発生したら、まずエラーメッセージを正確に読む
2. 公式ドキュメントを確認（WebFetch/WebSearch）
3. 最新の仕様や変更点を確認
4. 調査結果を記録してから対応策を実装

---

## プロジェクト情報

### PayPay Sandbox環境の正確な仕様（2025-01-09調査済み）

#### PayPayアプリのDeveloper Mode
**事実**: PayPayアプリはSandbox環境に対応している
- 通常のPayPayアプリをDeveloper Modeに切り替えることで使用可能
- APP_DEEP_LINKはSandbox環境でも正常に動作する

#### Developer Mode切り替え手順
1. PayPayアプリのサインイン画面でPayPayロゴを7回タップ
2. Developer Mode Sign Inへの切り替えを確認
3. テストユーザーでログイン
4. OTP: 1234を入力

#### API仕様
- Sandbox API: `https://stg-api.sandbox.paypay.ne.jp/v2/`
- redirectType: モバイルは"APP_DEEP_LINK"、デスクトップは"WEB_LINK"

---

## 過去の誤った推測と修正

### 2025-01-09: PayPay Sandbox APP_DEEP_LINK
**誤った推測**: 「サンドボックス環境は実際のPayPayアプリに対応していない」
**事実**: PayPayアプリのDeveloper Modeで対応している
**学習**: 推測せずに公式ドキュメントを確認すべきだった

---

## ファイル整理ルール（2025-01-09追加）

### 不要ファイルの取り扱い
- **完全削除はしない**: 不要になったファイルは削除せず、`/public/data/disabled/`フォルダに移動
- **移動対象**: 古いバージョンのファイル、バックアップファイル、未使用ファイル
- **理由**: 将来的に参照が必要になる可能性があるため

### 2025-01-09に移動したファイル
`/public/data/disabled/`に以下のファイルを移動：
- `three-powers.json` - 古い月相ベースの形式
- `three-powers-calculated.json` - クラスなしの古い形式
- `otsukisama-patterns-complete.json` - 古いバックアップ
- `otsukisama-patterns-complete-backup-20250828.json` - 古いバックアップ
- `otsukisama-patterns-complete.json.backup` - 古いバックアップ
- `otsukisama-patterns-v2.json` - 古いバージョン
- `otsukisama-patterns-v3-backup.json` - バックアップ
- `fortune_graph_all_64_patterns.json.backup` - バックアップ
- `fortune_graph_all_64_patterns.json.bak` - バックアップ

---

## 今後の対応

1. **エラー発生時は必ず調査**
   - WebSearch/WebFetchで公式情報を確認
   - StackOverflow、GitHub Issues等も参照
   - 推測での回答は絶対にしない

2. **調査結果の記録**
   - このファイル（CLAUDE.md）に記録
   - memoryシステムにも保存
   - 日付と調査元を明記

3. **ユーザーへの報告**
   - 調査中であることを伝える
   - 調査結果を正確に報告
   - 推測や憶測は一切含めない