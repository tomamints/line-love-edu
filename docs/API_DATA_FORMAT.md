# OpenAI API 送信データフォーマット

## 実際の送信例（改善後）

AIAnalyzerがOpenAI APIに送信するデータの実例：

```
🚀 OpenAI APIに送信するデータ:
📊 メッセージ数: 2
📝 Message 1 (system):
   文字数: 140文字
   内容プレビュー: あなたは恋愛心理の専門家です。LINEの会話履歴から相手の性格、感情パターン、関係性を分析します。
分析は具体的で実用的なものにし、必ずJSON形式で返答してください。
   
📝 Message 2 (user):
   文字数: 約5000文字
   内容プレビュー: 
以下のLINE会話を分析して、恋愛アドバイスを生成してください。

## 会話履歴（👤=ユーザー、💬=相手）
👤: えー何そのスタンプもう会いたい。笑
💬: [スタンプ]
👤: そのスタンプかわいい
💬: でしょ？お気に入り
👤: 今日も仕事遅くなりそう
💬: お疲れ様！無理しないでね
👤: ありがとう、癒される
💬: いつでも話聞くよ〜
...（最大3000文字の会話履歴）

## 会話分析データ（ConversationPeaksAnalyzerによる自動分析）
- 盛り上がった話題: 映画, カフェ  ← 会話から自動抽出された話題
- 盛り上がり度: 85%  ← メッセージ頻度、文字数、絵文字使用量から計算
- 感情: positive  ← 感情分析（positive/negative/neutral）

※ このデータは `/core/ai-analyzer/conversation-peaks.js` の `ConversationPeaksAnalyzer` クラスが
  会話履歴を分析して自動生成します。存在しない場合はこのセクション自体が省略されます。

## プロフィール（データベースから取得）
- ユーザー: 27歳  ← ProfilesDBから取得
- 相手: 27歳 女性  ← ユーザーが設定した情報

※ このデータは `/core/database/profiles-db.js` からユーザーIDをキーに取得されます。
  存在しない場合はこのセクション自体が省略されます。

## タスク：会話分析と恋愛アドバイスの生成

あなたのタスクは、上記の会話履歴を分析して、以下の項目について具体的な分析結果をJSON形式で返すことです。

### 分析項目の説明：

1. **personality** (配列・必須): 相手の性格特徴を3つ挙げてください
   - 例: ["優しい", "マイペース", "好奇心旺盛"]

2. **interests** (配列・必須): 会話から読み取れる相手の興味・関心事を3つ
   - 例: ["映画", "カフェ巡り", "音楽"]

3. **relationshipStage** (数値・必須): 現在の関係性を1-10で評価
   - 1-3: 知り合い程度
   - 4-6: 友達
   - 7-9: 好意がある関係
   - 10: 恋人

4. **advice** (配列・必須): ユーザーへの具体的な恋愛アドバイスを2つ
   - 実行可能で具体的な内容にしてください

5. **emotionalPattern** (オブジェクト・必須): 相手の感情パターン
   - positive: ポジティブな反応を示す話題（2つ）
   - negative: ネガティブまたは冷たい反応を示す話題（1つ）

6. **communicationStyle** (文字列・必須): 相手のコミュニケーションスタイル
   - 例: "絵文字多め・フレンドリー" や "丁寧・慎重" など

7. **optimalTiming** (オブジェクト・必須): 連絡のベストタイミング
   - timeOfDay: "朝", "昼", "夕方", "夜", "深夜" のいずれか
   - frequency: "毎日", "2-3日に1回", "週1-2回" など

8. **avoidTopics** (配列・必須): 避けるべき話題のリスト

9. **responsePatterns** (オブジェクト・必須): 相手の返信パターン分析
   - quickResponse: すぐ返信が来る時の特徴
   - thoughtfulResponse: 時間をかけて返信する時の特徴
   - shortResponse: 短い返信の時の特徴
   - enthusiasticResponse: 盛り上がっている時の特徴

10. **suggestedActions** (配列・必須): 具体的なアクション提案（最低1つ、最大3つ）
    各アクションには以下を含める：
    - action: 送るべきメッセージの具体例
    - expectedResponse: 予想される相手の反応
    - timing: いつ送るべきか（"今すぐ", "明日の朝", "週末" など）
    - successRate: 成功確率（0-100の数値）
    - basedOn: この提案の根拠（会話のどの部分から判断したか）

### 出力形式：
以下の形式で、JSONのみを返してください。説明文や追加のテキストは不要です。

```json
{
  "personality": ["優しい", "思いやりがある", "少し慎重"],
  "interests": ["カフェ巡り", "映画鑑賞", "音楽"],
  "relationshipStage": 6,
  "advice": [
    "相手は慎重なタイプなので、焦らずゆっくり関係を深めましょう",
    "映画の話題で盛り上がることが多いので、新作映画の情報を共有すると良いでしょう"
  ],
  "emotionalPattern": {
    "positive": ["趣味の話", "日常の出来事"],
    "negative": ["仕事の愚痴"]
  },
  "communicationStyle": "絵文字多め・親しみやすい",
  "optimalTiming": {
    "timeOfDay": "夜",
    "frequency": "毎日"
  },
  "avoidTopics": ["過去の恋愛", "収入の話"],
  "responsePatterns": {
    "quickResponse": ["挨拶", "簡単な質問"],
    "thoughtfulResponse": ["相談事", "将来の話"],
    "shortResponse": ["朝の時間帯", "仕事中"],
    "enthusiasticResponse": ["週末の予定", "趣味の話"]
  },
  "suggestedActions": [
    {
      "action": "今度の週末、気になってたカフェに行ってみない？",
      "expectedResponse": "いいね！どこのカフェ？",
      "timing": "金曜日の夜",
      "successRate": 85,
      "basedOn": "カフェの話題での高い反応率"
    }
  ]
}
```

重要：
- 上記の例と同じ構造で返してください
- すべての値は実際の会話内容に基づいて具体的に記載
- relationshipStageは1-10の整数値
- successRateは0-100の整数値
- JSON以外のテキストは含めないでください

📊 推定トークン数: 2000-2500
```

## データ取得の流れ

### データソースと処理フロー
```
1. メッセージ履歴
   └→ messagesDB.getMessages(userId)
      └→ 最新200件を取得、各200文字に制限

2. 会話分析データ (条件付き)
   └→ ConversationPeaksAnalyzer.analyzeConversationPeaks(messages)
      ├→ 会話セグメント分割
      ├→ 盛り上がり度計算（メッセージ頻度、文字数、絵文字）
      ├→ トピック抽出（キーワード分析）
      └→ 感情分析（positive/negative/neutral）

3. プロフィール情報 (条件付き)
   └→ ProfilesDB.getProfile(userId)
      └→ ユーザーが設定した年齢、性別情報
```

## データ構造の詳細

### 1. システムプロンプト（Message 1）
- **役割**: system
- **文字数**: 約140文字
- **内容**: 恋愛心理の専門家としての役割定義、JSON形式での返答指示

### 2. ユーザープロンプト（Message 2）
- **役割**: user
- **構成要素**:
  1. **会話履歴** (最大3000文字)
     - 最新200件のメッセージから抽出
     - 各メッセージは200文字に制限
     - `👤: [メッセージ]` 形式で視覚的に区別
  
  2. **会話分析データ** (条件付き、約150文字)
     - 盛り上がった話題
     - 盛り上がり度（パーセンテージ）
     - 感情トーン
  
  3. **プロフィール情報** (条件付き、約100文字)
     - 年齢、性別情報
  
  4. **タスク説明と分析項目** (約2000文字)
     - 10個の分析項目の詳細説明
     - データ型と必須/任意の明示
     - 具体例の提示
     - 出力形式の明確な指示

## 改善された点

### 改善前の問題点
1. ❌ プロンプトが曖昧で、何を返すべきか不明確
2. ❌ 会話履歴が1000文字と少なすぎる
3. ❌ JSON例が実際の値を含まず、説明が不足
4. ❌ 各項目の意味や目的が不明

### 改善後の利点
1. ✅ **明確な指示** - 各項目の意味、データ型、必須性を詳細に説明
2. ✅ **会話履歴3倍** - 1000文字→3000文字でより多くの文脈を提供
3. ✅ **構造化** - Markdown形式で見やすく整理
4. ✅ **具体例** - 各項目に期待する出力の例を提示
5. ✅ **視覚的区別** - 絵文字（👤💬）で会話の発話者を明確化

## トークン使用量
- **改善前**: 約1000-1200トークン
- **改善後**: 約2000-2500トークン
- **maxTokens設定**: 16,000トークン（十分な余裕）
- **実際の応答**: 通常1000-2000トークン

## 期待される効果
1. **精度向上** - より明確な指示により、期待通りの形式で返答
2. **エラー削減** - JSON解析エラーの減少
3. **分析品質** - より多くの会話データによる精度の高い分析
4. **一貫性** - 毎回同じ形式での出力が期待できる

## 参照ファイル
- `/core/ai-analyzer/index.js` - AIAnalyzerクラス
- `/config/ai.config.js` - API設定（モデル、トークン数等）