# OpenAI API 送信データフォーマット

## 実際の送信例

AIAnalyzerがOpenAI APIに送信するデータの実例：

```
🚀 OpenAI APIに送信するデータ:
📊 メッセージ数: 2
📝 Message 1 (system):
   文字数: 67文字
   内容プレビュー: 恋愛心理分析AIです。トーク履歴を分析し、短いJSON形式で返します。
   
📝 Message 2 (user):
   文字数: 2500文字（推定）
   内容プレビュー: 
会話:
ユーザー: えー何そのスタンプもう会いたい。笑
相手: [スタンプ]
ユーザー: そのスタンプかわいい
相手: でしょ？お気に入り
ユーザー: 今日も仕事遅くなりそう
相手: お疲れ様！無理しないでね
ユーザー: ありがとう、癒される
相手: いつでも話聞くよ〜
...（最大1000文字の会話履歴）

【会話の盛り上がり分析】
- 最も盛り上がった話題: 映画, カフェ
- 盛り上がり度: 85/100
- 感情トーン: positive
- パターン: 趣味の話, 日常会話
- 推奨時間帯: 夜20-22時

【プロフィール情報】
- ユーザー年齢: 27歳
- 相手の年齢: 27歳
- 年齢差: 0歳
- 相手の性別: 女性

年齢差や性別を考慮した具体的なアドバイスを含めてください。

短いJSON形式で分析:
{
  "personality": ["性格1", "性格2", "性格3"],
  "interests": ["興味1", "興味2", "興味3"],
  "relationshipStage": 5,
  "advice": ["アドバイス1", "アドバイス2"],
  "emotionalPattern": {
    "positive": ["ポジティブ1", "ポジティブ2"],
    "negative": ["ネガティブ1"]
  },
  "communicationStyle": "スタイル",
  "optimalTiming": {
    "timeOfDay": "夜",
    "frequency": "頻度"
  },
  "avoidTopics": ["避ける話題"],
  "responsePatterns": {
    "quickResponse": ["パターン1"],
    "thoughtfulResponse": ["パターン2"],
    "shortResponse": ["パターン3"],
    "enthusiasticResponse": ["パターン4"]
  },
  "suggestedActions": [{
    "action": "行動",
    "expectedResponse": "反応",
    "timing": "時間",
    "successRate": 85,
    "basedOn": "朝の挨拶への反応パターン"
  }]
}

📊 推定トークン数: 1000-1200
```

## データ構造の詳細

### 1. システムプロンプト（Message 1）
- **役割**: system
- **文字数**: 約70文字
- **内容**: AIの役割定義（シンプルで短い）

### 2. ユーザープロンプト（Message 2）
- **役割**: user
- **構成要素**:
  1. **会話履歴** (最大1000文字)
     - 最新200件のメッセージから抽出
     - 各メッセージは200文字に制限
     - `ユーザー: [メッセージ]` 形式
  
  2. **盛り上がり分析コンテキスト** (約300文字)
     - 話題、スコア、感情トーン
     - パターン、推奨時間帯
  
  3. **プロフィール情報** (約200文字)
     - 年齢、性別情報
  
  4. **JSON出力例** (約1000文字)
     - 期待する出力形式の例示

## 問題点と改善案

### 現在の問題点
1. **JSON例が長すぎる** - 全体の約40%を占める
2. **会話履歴が1000文字制限** - 情報が少ない
3. **重複した情報** - JSON例と説明が重複

### 改善案
1. JSON例を簡潔にする（キー名のみ示す）
2. 会話履歴を3000文字まで増やす
3. より多くのメッセージを含める（現在は最新100件→200件）

## トークン使用量
- **現在**: 約1000-1200トークン（日本語）
- **maxTokens設定**: 16,000トークン
- **実際の応答**: 通常500-1000トークン

## 参照ファイル
- `/core/ai-analyzer/index.js` - AIAnalyzerクラス
- `/config/ai.config.js` - API設定（モデル、トークン数等）