<!DOCTYPE html>
<html lang="ja">
<head>
    <title>LINEフロー完全テスト</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        h1 { color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        h2 { color: #666; margin-top: 30px; }
        .step { margin: 20px 0; padding: 15px; background: #f9f9f9; border-left: 4px solid #4CAF50; }
        .step-title { font-weight: bold; color: #4CAF50; margin-bottom: 10px; }
        button { background: #4CAF50; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        button:hover { background: #45a049; }
        .result { margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .info { background: #e3f2fd; color: #1976d2; padding: 10px; border-radius: 5px; margin: 10px 0; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .link-button { display: inline-block; padding: 10px 20px; background: #00B900; color: white; text-decoration: none; border-radius: 5px; margin: 5px; }
        .link-button:hover { background: #009900; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🟢 LINEからの完全診断フローテスト</h1>
        
        <div class="info">
            <strong>テストユーザーID:</strong> U69bf66f589f5303a9615e94d7a7dc693<br>
            <strong>説明:</strong> LINEアプリから診断に入る完全な流れをシミュレートします
        </div>
        
        <h2>📝 ステップ1: プロフィール4軸データ設定</h2>
        <div class="step">
            <div class="step-title">LINE登録後のQ3〜Q6回答をシミュレート</div>
            <p>LINEでQ3〜Q6に回答した状態を再現します</p>
            <button onclick="setupProfile()">プロフィール設定</button>
            <div id="profileResult"></div>
        </div>
        
        <h2>🌙 ステップ2: 診断入力ページへ</h2>
        <div class="step">
            <div class="step-title">LINEリッチメニューから診断開始</div>
            <p>実際のLINEアプリでは、リッチメニューの「おつきさま診断」をタップします</p>
            <a href="/lp-otsukisama-input.html?userId=U69bf66f589f5303a9615e94d7a7dc693" class="link-button" target="_blank">
                診断入力ページを開く
            </a>
        </div>
        
        <h2>🔍 ステップ3: データ確認</h2>
        <div class="step">
            <div class="step-title">現在のデータ状態を確認</div>
            <button onclick="checkCurrentData()">データ確認</button>
            <div id="dataResult"></div>
        </div>
        
        <h2>📊 ステップ4: 診断履歴確認</h2>
        <div class="step">
            <div class="step-title">作成された診断を確認</div>
            <button onclick="checkDiagnoses()">診断履歴取得</button>
            <div id="diagnosesResult"></div>
        </div>
    </div>
    
    <script>
        const userId = 'U69bf66f589f5303a9615e94d7a7dc693';
        
        async function setupProfile() {
            const resultDiv = document.getElementById('profileResult');
            resultDiv.innerHTML = '<p>処理中...</p>';
            
            try {
                // プロフィールの4軸データを設定
                const profileData = {
                    userId: userId,
                    emotionalExpression: 'straight',  // Q3: ストレート告白型
                    distanceStyle: 'close',           // Q4: ベッタリ依存型
                    loveValues: 'romantic',            // Q5: ロマンチスト型
                    loveEnergy: 'fluctuating'          // Q6: 波あり型
                };
                
                const response = await fetch('/api/update-profile-axes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="result">
                            <h3>✅ プロフィール設定完了</h3>
                            <p>Q3〜Q6の回答がプロフィールに保存されました：</p>
                            <ul>
                                <li>Q3 感情表現: ストレート告白型</li>
                                <li>Q4 距離感: ベッタリ依存型</li>
                                <li>Q5 価値観: ロマンチスト型</li>
                                <li>Q6 エネルギー: 波あり型</li>
                            </ul>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="result error">エラー: ${JSON.stringify(result)}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">エラー: ${error.message}</div>`;
            }
        }
        
        async function checkCurrentData() {
            const resultDiv = document.getElementById('dataResult');
            resultDiv.innerHTML = '<p>確認中...</p>';
            
            try {
                // プロフィールデータを確認
                const response = await fetch(`/api/get-love-profile?userId=${userId}`);
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="result">
                            <h3>📊 現在のプロフィールデータ</h3>
                            <pre>${JSON.stringify(data.profile, null, 2)}</pre>
                            <p><strong>4軸データ確認:</strong></p>
                            <ul>
                                <li>感情表現: ${data.profile.emotionalExpression || '未設定'}</li>
                                <li>距離感: ${data.profile.distanceStyle || '未設定'}</li>
                                <li>価値観: ${data.profile.loveValues || '未設定'}</li>
                                <li>エネルギー: ${data.profile.loveEnergy || '未設定'}</li>
                            </ul>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="result error">プロフィールが見つかりません</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">エラー: ${error.message}</div>`;
            }
        }
        
        async function checkDiagnoses() {
            const resultDiv = document.getElementById('diagnosesResult');
            resultDiv.innerHTML = '<p>取得中...</p>';
            
            try {
                const response = await fetch(`/api/profile-form-v2?action=get-user-diagnoses&userId=${userId}`);
                const data = await response.json();
                
                if (data.success && data.diagnoses) {
                    let html = `
                        <div class="result">
                            <h3>📝 診断履歴 (${data.diagnoses.length}件)</h3>
                    `;
                    
                    for (const diag of data.diagnoses) {
                        const detailResponse = await fetch(`/api/profile-form-v2?action=get-diagnosis&id=${diag.id}&userId=${userId}`);
                        const detail = await detailResponse.json();
                        
                        html += `
                            <div style="margin: 15px 0; padding: 10px; background: #f9f9f9; border-radius: 5px;">
                                <p><strong>診断ID:</strong> ${diag.id}</p>
                                <p><strong>作成日時:</strong> ${new Date(diag.created_at).toLocaleString('ja-JP')}</p>
                                <p><strong>ユーザー名:</strong> ${detail.diagnosis?.user_name || '未設定'}</p>
                                <p><strong>4軸データ:</strong></p>
                                <ul>
                                    <li>感情表現: ${detail.diagnosis?.emotional_expression || '未設定'}</li>
                                    <li>距離感: ${detail.diagnosis?.distance_style || '未設定'}</li>
                                    <li>価値観: ${detail.diagnosis?.love_values || '未設定'}</li>
                                    <li>エネルギー: ${detail.diagnosis?.love_energy || '未設定'}</li>
                                </ul>
                                <p><strong>アクセスレベル:</strong> ${detail.accessLevel}</p>
                                <a href="/lp-otsukisama-unified.html?id=${diag.id}&userId=${userId}" class="link-button" target="_blank">
                                    プレビューを開く
                                </a>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="result">診断履歴がありません</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">エラー: ${error.message}</div>`;
            }
        }
        
        // ページ読み込み時に自動でデータを確認
        window.onload = async function() {
            await checkCurrentData();
        };
    </script>
</body>
</html>