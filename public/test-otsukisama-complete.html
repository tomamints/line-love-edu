<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>おつきさま診断 - 統合テスト</title>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-header {
            background: #f0f0f0;
            padding: 10px;
            margin: -20px -20px 20px -20px;
            border-radius: 6px 6px 0 0;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .pattern-card {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        .axis-test {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .axis-item {
            flex: 1;
            min-width: 200px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>おつきさま診断 完全版 統合テスト</h1>
    
    <div class="test-section">
        <div class="test-header">
            <h2>📊 テスト概要</h2>
        </div>
        <div id="test-summary"></div>
    </div>

    <div class="test-section">
        <div class="test-header">
            <h2>1️⃣ データローダーテスト</h2>
        </div>
        <button onclick="testDataLoader()">データローダーをテスト</button>
        <div id="dataloader-results"></div>
    </div>

    <div class="test-section">
        <div class="test-header">
            <h2>2️⃣ 4軸性格要素テスト</h2>
        </div>
        <button onclick="test4AxisPersonality()">4軸をテスト</button>
        <div class="axis-test" id="axis-test-container"></div>
        <div id="axis-results"></div>
    </div>

    <div class="test-section">
        <div class="test-header">
            <h2>3️⃣ 運勢グラフテスト (64パターン)</h2>
        </div>
        <button onclick="testFortuneGraphs()">全パターンをテスト</button>
        <div id="graph-results"></div>
    </div>

    <div class="test-section">
        <div class="test-header">
            <h2>4️⃣ カレンダーパターンテスト</h2>
        </div>
        <button onclick="testCalendarPatterns()">カレンダーをテスト</button>
        <div id="calendar-results"></div>
    </div>

    <div class="test-section">
        <div class="test-header">
            <h2>5️⃣ 統合動作テスト</h2>
        </div>
        <button onclick="testIntegration()">統合テスト実行</button>
        <div id="integration-results"></div>
    </div>

    <script>
        const testResults = {
            dataLoader: false,
            fourAxis: false,
            fortuneGraph: false,
            calendar: false,
            integration: false
        };

        function updateSummary() {
            const summary = document.getElementById('test-summary');
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(v => v).length;
            const percentage = Math.round((passed / total) * 100);
            
            summary.innerHTML = `
                <div class="test-result ${percentage === 100 ? 'success' : percentage > 50 ? 'warning' : 'error'}">
                    <strong>テスト進捗:</strong> ${passed}/${total} (${percentage}%)
                    <br>
                    データローダー: ${testResults.dataLoader ? '✅' : '❌'}
                    | 4軸: ${testResults.fourAxis ? '✅' : '❌'}
                    | グラフ: ${testResults.fortuneGraph ? '✅' : '❌'}
                    | カレンダー: ${testResults.calendar ? '✅' : '❌'}
                    | 統合: ${testResults.integration ? '✅' : '❌'}
                </div>
            `;
        }

        async function testDataLoader() {
            const results = document.getElementById('dataloader-results');
            results.innerHTML = '<div class="warning">テスト中...</div>';
            
            try {
                // データローダーのスクリプトを動的にロード
                await loadScript('js/otsukisama-data-loader.js');
                
                // データ読み込み
                await window.OtsukisamaDataLoader.loadAllData();
                
                const tests = [
                    { name: 'パターンデータ', test: () => window.OtsukisamaDataLoader.patternsData !== null },
                    { name: '3つの力データ', test: () => window.OtsukisamaDataLoader.threePowersData !== null },
                    { name: '性格軸データ', test: () => window.OtsukisamaDataLoader.personalityAxesData !== null },
                    { name: '月相説明', test: () => window.OtsukisamaDataLoader.moonPhasesData !== null },
                    { name: '隠れ月相説明', test: () => window.OtsukisamaDataLoader.hiddenPhasesData !== null },
                    { name: 'UIテキスト', test: () => window.OtsukisamaDataLoader.uiTextsData !== null }
                ];
                
                let html = '';
                let allPassed = true;
                
                for (const t of tests) {
                    const passed = t.test();
                    allPassed = allPassed && passed;
                    html += `<div class="test-result ${passed ? 'success' : 'error'}">
                        ${passed ? '✅' : '❌'} ${t.name}
                    </div>`;
                }
                
                // パターン0のテスト
                const pattern0 = window.OtsukisamaDataLoader.getPatternFortune(0);
                if (pattern0) {
                    html += '<div class="test-result success">✅ パターン0データ取得成功</div>';
                } else {
                    html += '<div class="test-result error">❌ パターン0データ取得失敗</div>';
                    allPassed = false;
                }
                
                results.innerHTML = html;
                testResults.dataLoader = allPassed;
                updateSummary();
                
            } catch (error) {
                results.innerHTML = `<div class="test-result error">❌ エラー: ${error.message}</div>`;
                testResults.dataLoader = false;
                updateSummary();
            }
        }

        async function test4AxisPersonality() {
            const results = document.getElementById('axis-results');
            const container = document.getElementById('axis-test-container');
            results.innerHTML = '<div class="warning">テスト中...</div>';
            
            // テストデータ
            const testProfile = {
                emotionalExpression: 'ストレート型',
                distanceStyle: 'じっくり型',
                loveValues: '安心感重視',
                loveEnergy: '情熱的'
            };
            
            // localStorageに保存
            localStorage.setItem('userPersonalityData', JSON.stringify(testProfile));
            
            try {
                // display.jsから関数を取得するため動的にロード
                await loadScript('js/lp-otsukisama-display.js');
                
                // 4軸の表示要素を作成
                container.innerHTML = `
                    <div class="axis-item">
                        <h4>感情表現</h4>
                        <div id="test-emotional-expression">-</div>
                    </div>
                    <div class="axis-item">
                        <h4>距離感</h4>
                        <div id="test-distance-style">-</div>
                    </div>
                    <div class="axis-item">
                        <h4>価値観</h4>
                        <div id="test-love-values">-</div>
                    </div>
                    <div class="axis-item">
                        <h4>エネルギー</h4>
                        <div id="test-love-energy">-</div>
                    </div>
                `;
                
                // マッピングテスト
                const typeMapping = {
                    'ストレート型': { name: 'ストレート型', image: 'straight' },
                    'じっくり型': { name: 'じっくり型', image: 'slow' },
                    '安心感重視': { name: '安心感重視', image: 'security' },
                    '情熱的': { name: '情熱的', image: 'passionate' }
                };
                
                let allPassed = true;
                let html = '';
                
                // 各軸のテスト
                const axes = [
                    { key: 'emotionalExpression', label: '感情表現', expected: 'ストレート型' },
                    { key: 'distanceStyle', label: '距離感', expected: 'じっくり型' },
                    { key: 'loveValues', label: '価値観', expected: '安心感重視' },
                    { key: 'loveEnergy', label: 'エネルギー', expected: '情熱的' }
                ];
                
                for (const axis of axes) {
                    const value = testProfile[axis.key];
                    const mapped = typeMapping[value];
                    
                    if (mapped && mapped.name === axis.expected) {
                        html += `<div class="test-result success">✅ ${axis.label}: ${axis.expected} → 正常マッピング</div>`;
                        document.getElementById(`test-${axis.key.replace(/([A-Z])/g, '-$1').toLowerCase()}`).textContent = axis.expected;
                    } else {
                        html += `<div class="test-result error">❌ ${axis.label}: マッピング失敗</div>`;
                        allPassed = false;
                    }
                }
                
                results.innerHTML = html;
                testResults.fourAxis = allPassed;
                updateSummary();
                
            } catch (error) {
                results.innerHTML = `<div class="test-result error">❌ エラー: ${error.message}</div>`;
                testResults.fourAxis = false;
                updateSummary();
            }
        }

        async function testFortuneGraphs() {
            const results = document.getElementById('graph-results');
            results.innerHTML = '<div class="warning">テスト中...</div>';
            
            try {
                // グラフデータを読み込み
                const response = await fetch('../docs/fortune_graph_all_64_patterns.json');
                const data = await response.json();
                
                let html = '';
                let allPassed = true;
                
                // 配列形式のデータをチェック
                if (!data.patterns || !Array.isArray(data.patterns)) {
                    html = '<div class="test-result error">❌ データ形式が不正です</div>';
                    allPassed = false;
                } else if (data.patterns.length !== 64) {
                    html = `<div class="test-result error">❌ パターン数が不正: ${data.patterns.length}/64</div>`;
                    allPassed = false;
                } else {
                    // 全64パターンのテスト
                    for (let i = 0; i < data.patterns.length; i++) {
                        const pattern = data.patterns[i];
                        
                        if (!pattern) {
                            html += `<div class="test-result error">❌ パターン${i}: データなし</div>`;
                            allPassed = false;
                            continue;
                        }
                        
                        // fortune_dataの構造をチェック
                        if (!pattern.fortune_data) {
                            html += `<div class="test-result error">❌ パターン${i}: fortune_dataなし</div>`;
                            allPassed = false;
                        } else {
                            const fortuneData = pattern.fortune_data;
                            const requiredKeys = ['overall', 'love', 'relationship', 'career', 'money'];
                            
                            for (const key of requiredKeys) {
                                if (!fortuneData[key] || fortuneData[key].length !== 12) {
                                    html += `<div class="test-result error">❌ パターン${i}: ${key}データ不正</div>`;
                                    allPassed = false;
                                    break;
                                }
                            }
                        }
                    }
                }
                
                if (allPassed) {
                    html = '<div class="test-result success">✅ 全64パターンのグラフデータが正常</div>';
                    
                    // サンプルパターンの詳細表示
                    const sampleIndices = [0, 17, 35, 63];
                    html += '<div class="pattern-grid">';
                    for (const idx of sampleIndices) {
                        const pattern = data.patterns[idx];
                        if (pattern && pattern.fortune_data && pattern.fortune_data.overall) {
                            html += `
                                <div class="pattern-card">
                                    <strong>パターン${idx}: ${pattern.pattern_id}</strong><br>
                                    特徴: ${pattern.characteristics}<br>
                                    総合運: [${pattern.fortune_data.overall.slice(0, 3).join(', ')}...]<br>
                                    平均: ${Math.round(pattern.fortune_data.overall.reduce((a, b) => a + b) / 12)}
                                </div>
                            `;
                        }
                    }
                    html += '</div>';
                }
                
                results.innerHTML = html;
                testResults.fortuneGraph = allPassed;
                updateSummary();
                
            } catch (error) {
                results.innerHTML = `<div class="test-result error">❌ エラー: ${error.message}</div>`;
                testResults.fortuneGraph = false;
                updateSummary();
            }
        }

        async function testCalendarPatterns() {
            const results = document.getElementById('calendar-results');
            results.innerHTML = '<div class="warning">テスト中...</div>';
            
            try {
                // カレンダーデータを読み込み
                const response = await fetch('data/moon-calendar-patterns-complete.json');
                const data = await response.json();
                
                let html = '';
                let allPassed = true;
                
                // patternsオブジェクトの存在確認
                if (!data.patterns || typeof data.patterns !== 'object') {
                    html = '<div class="test-result error">❌ データ形式が不正です</div>';
                    allPassed = false;
                } else {
                    // 全64パターンの存在確認（数字キー形式）
                    for (let i = 0; i < 64; i++) {
                        const patternKey = i.toString();
                        const pattern = data.patterns[patternKey];
                        
                        if (!pattern) {
                            html += `<div class="test-result error">❌ パターン${patternKey}: データなし</div>`;
                            allPassed = false;
                            continue;
                        }
                        
                        // 必須フィールドの確認
                        const requiredFields = ['lucky_days', 'power_days', 'caution_days', 'special_marks', 'monthly_message', 'love_advice'];
                        for (const field of requiredFields) {
                            if (!pattern[field]) {
                                html += `<div class="test-result error">❌ パターン${patternKey}: ${field}なし</div>`;
                                allPassed = false;
                            }
                        }
                    }
                }
                
                if (allPassed) {
                    html = '<div class="test-result success">✅ 全64パターンのカレンダーデータが正常</div>';
                    
                    // サンプルパターンの詳細
                    const samplePattern = data.patterns['0'];
                    if (samplePattern) {
                        html += `
                            <div class="test-result success">
                                <strong>パターン0サンプル (${samplePattern.pattern_id}):</strong><br>
                                ラッキーデー: ${samplePattern.lucky_days.join(', ')}<br>
                                パワーデー: ${samplePattern.power_days.join(', ')}<br>
                                注意日: ${samplePattern.caution_days.join(', ')}<br>
                                月間メッセージ: ${samplePattern.monthly_message.substring(0, 50)}...
                            </div>
                        `;
                    }
                }
                
                results.innerHTML = html;
                testResults.calendar = allPassed;
                updateSummary();
                
            } catch (error) {
                results.innerHTML = `<div class="test-result error">❌ エラー: ${error.message}</div>`;
                testResults.calendar = false;
                updateSummary();
            }
        }

        async function testIntegration() {
            const results = document.getElementById('integration-results');
            results.innerHTML = '<div class="warning">統合テスト実行中...</div>';
            
            try {
                // 全モジュールのロードテスト
                const scripts = [
                    'js/otsukisama-data-loader.js',
                    'js/lp-otsukisama-display.js',
                    'js/lp-otsukisama-graph.js',
                    'js/lp-otsukisama-calendar.js',
                    'js/lp-otsukisama-api.js'
                ];
                
                let html = '';
                let allPassed = true;
                
                for (const script of scripts) {
                    try {
                        await loadScript(script);
                        html += `<div class="test-result success">✅ ${script} ロード成功</div>`;
                    } catch (error) {
                        html += `<div class="test-result error">❌ ${script} ロード失敗</div>`;
                        allPassed = false;
                    }
                }
                
                // 統合動作テスト
                if (allPassed) {
                    // パターンID生成テスト
                    const testDate = { year: 2000, month: 1, day: 1 };
                    if (typeof generatePatternId === 'function') {
                        const patternId = generatePatternId(testDate.year, testDate.month, testDate.day);
                        html += `<div class="test-result success">✅ パターンID生成: ${patternId}</div>`;
                    } else {
                        html += `<div class="test-result error">❌ generatePatternId関数が見つかりません</div>`;
                        allPassed = false;
                    }
                    
                    // データローダー初期化テスト
                    if (window.OtsukisamaDataLoader && window.OtsukisamaDataLoader.isLoaded) {
                        html += `<div class="test-result success">✅ データローダー初期化済み</div>`;
                    } else {
                        html += `<div class="test-result warning">⚠️ データローダー未初期化</div>`;
                    }
                }
                
                results.innerHTML = html;
                testResults.integration = allPassed;
                updateSummary();
                
            } catch (error) {
                results.innerHTML = `<div class="test-result error">❌ エラー: ${error.message}</div>`;
                testResults.integration = false;
                updateSummary();
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // 既にロード済みかチェック
                if (document.querySelector(`script[src="${src}"]`)) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // 初期表示
        updateSummary();
    </script>
</body>
</html>