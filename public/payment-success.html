<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠæ”¯æ‰•ã„å®Œäº† - ãŠã¤ãã•ã¾è¨ºæ–­</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', YuGothic, Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            animation: checkmark 0.8s ease-out 0.3s both;
        }
        
        @keyframes checkmark {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .success-icon svg {
            width: 50px;
            height: 50px;
            stroke: #667eea;
            stroke-width: 3;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .checkmark-path {
            stroke-dasharray: 50;
            stroke-dashoffset: 50;
            animation: drawCheck 0.5s ease-out 0.8s forwards;
        }
        
        @keyframes drawCheck {
            to {
                stroke-dashoffset: 0;
            }
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px 30px;
        }
        
        .purchase-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .info-row:last-child {
            margin-bottom: 0;
            padding-top: 12px;
            border-top: 1px solid #dee2e6;
            font-weight: bold;
            font-size: 16px;
        }
        
        .info-label {
            color: #6c757d;
        }
        
        .info-value {
            color: #212529;
            font-weight: 500;
        }
        
        .message {
            text-align: center;
            margin-bottom: 30px;
            color: #495057;
            line-height: 1.6;
        }
        
        .message .moon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .btn-primary {
            display: block;
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .footer-note {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            font-size: 13px;
            color: #856404;
            text-align: center;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="success-icon">
                <svg viewBox="0 0 24 24">
                    <path class="checkmark-path" d="M5 12l5 5L20 7"/>
                </svg>
            </div>
            <h1>ãŠæ”¯æ‰•ã„å®Œäº†</h1>
            <p class="subtitle">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</p>
        </div>
        
        <div class="content">
            <div class="purchase-info">
                <div class="info-row">
                    <span class="info-label">å•†å“å</span>
                    <span class="info-value" id="productName">ãŠã¤ãã•ã¾è¨ºæ–­ - å®Œå…¨ç‰ˆ</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ãŠæ”¯æ‰•ã„æ–¹æ³•</span>
                    <span class="info-value">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ã”åˆ©ç”¨æ—¥</span>
                    <span class="info-value" id="purchaseDate">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ãŠæ”¯æ‰•ã„é‡‘é¡</span>
                    <span class="info-value">Â¥980</span>
                </div>
            </div>
            
            <div class="message">
                <div class="moon">ğŸŒ™âœ¨</div>
                <p>
                    ãŠã¤ãã•ã¾è¨ºæ–­ã®å®Œå…¨ç‰ˆã‚’ã”è³¼å…¥ã„ãŸã ã<br>
                    èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br><br>
                    ã‚ãªãŸã®æœˆã®ãƒ‘ãƒ¯ãƒ¼ã¨<br>
                    ä»Šå¾Œ3ãƒ¶æœˆã®é‹å‹¢ã‚’ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã€‚
                </p>
            </div>
            
            <a href="#" id="viewResultBtn" class="btn-primary">
                è¨ºæ–­çµæœã‚’ç¢ºèªã™ã‚‹
            </a>
            
            <!-- LINEã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
            <button onclick="returnToLINE()" class="btn-primary" style="background: #00B900; margin-top: 15px; border: none; width: 100%; padding: 18px; border-radius: 50px; color: white; font-size: 18px; font-weight: bold; cursor: pointer;">
                LINEã‚¢ãƒ—ãƒªã«æˆ»ã‚‹ â†©
            </button>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
            
            <div class="footer-note">
                â€» è¨ºæ–­çµæœã¯ã„ã¤ã§ã‚‚ã€Œå±¥æ­´ã€ã‹ã‚‰ç¢ºèªã§ãã¾ã™<br>
                LINEã§ã€Œå±¥æ­´ã€ã¨é€ä¿¡ã—ã¦ãã ã•ã„
            </div>
        </div>
    </div>
    
    <script>
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const diagnosisId = urlParams.get('id');
        const userId = urlParams.get('userId');
        const paymentStatus = urlParams.get('payment');
        const merchantPaymentId = urlParams.get('merchantPaymentId');
        
        // LINEã‚¢ãƒ—ãƒªã«æˆ»ã‚‹æ©Ÿèƒ½
        function returnToLINE() {
            // LINEã®URLã‚¹ã‚­ãƒ¼ãƒ ã‚’ä½¿ç”¨
            const lineScheme = 'line://';
            
            // LINEã‚¢ãƒ—ãƒªã‚’é–‹ã“ã†ã¨ã™ã‚‹
            const startTime = Date.now();
            window.location.href = lineScheme;
            
            // 500mså¾Œã«ãƒã‚§ãƒƒã‚¯ - ã‚¢ãƒ—ãƒªãŒé–‹ã„ãŸã‹ã©ã†ã‹
            setTimeout(() => {
                // ãƒšãƒ¼ã‚¸ãŒã¾ã ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆï¼ˆLINEã‚¢ãƒ—ãƒªãŒé–‹ã‹ãªã‹ã£ãŸï¼‰
                if (Date.now() - startTime < 1500) {
                    console.log('LINEã‚¢ãƒ—ãƒªã¸ã®è‡ªå‹•é·ç§»ã‚’è©¦ã¿ã¾ã—ãŸãŒã€ãƒ–ãƒ©ã‚¦ã‚¶ã«ç•™ã¾ã£ã¦ã„ã¾ã™');
                }
            }, 500);
        }
        
        // PayPayã‹ã‚‰æˆ»ã£ã¦ããŸå ´åˆã€è‡ªå‹•çš„ã«LINEã‚¢ãƒ—ãƒªã«æˆ»ã‚‹
        if (merchantPaymentId && !sessionStorage.getItem('lineReturnAttempted')) {
            // äºŒé‡å®Ÿè¡Œã‚’é˜²ã
            sessionStorage.setItem('lineReturnAttempted', 'true');
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰LINEã«æˆ»ã‚‹
            setTimeout(() => {
                console.log('PayPayæ±ºæ¸ˆå®Œäº† - LINEã‚¢ãƒ—ãƒªã«æˆ»ã‚Šã¾ã™');
                returnToLINE();
            }, 3000); // 3ç§’å¾Œã«LINEã«æˆ»ã‚‹
        }
        
        // æ—¥ä»˜ã‚’è¨­å®š
        document.getElementById('purchaseDate').textContent = 
            new Date().toLocaleDateString('ja-JP', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        
        // è¨ºæ–­çµæœã¸ã®ãƒªãƒ³ã‚¯ã‚’è¨­å®š
        const viewResultBtn = document.getElementById('viewResultBtn');
        if (diagnosisId && userId) {
            viewResultBtn.href = `/lp-otsukisama-unified.html?id=${diagnosisId}&userId=${userId}`;
        } else if (diagnosisId) {
            viewResultBtn.href = `/lp-otsukisama-unified.html?id=${diagnosisId}`;
        }
        
        // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        viewResultBtn.addEventListener('click', function(e) {
            if (this.href === '#') {
                e.preventDefault();
                alert('è¨ºæ–­IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚LINEã‹ã‚‰ã€Œå±¥æ­´ã€ã¨é€ä¿¡ã—ã¦è¨ºæ–­çµæœã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
                return;
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            this.style.display = 'none';
            document.getElementById('loading').style.display = 'block';
        });
        
        // PayPayã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã®å ´åˆã€ã¾ãŸã¯payment=successã®å ´åˆã¯æˆåŠŸã¨åˆ¤å®š
        // PayPayã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¿æŒã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€diagnosisIdãŒã‚ã‚Œã°æˆåŠŸã¨ã¿ãªã™
        const isPayPayRedirect = document.referrer.includes('paypay') || 
                                window.location.href.includes('paypay') ||
                                merchantPaymentId?.includes('diag_');
        
        // PayPayã‚¢ãƒ—ãƒªã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’æ¤œå‡º
        const isFromPayPayApp = window.location.search.includes('merchantPaymentId') && 
                               /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã®æ¡ä»¶ã‚’æ˜ç¢ºåŒ–
        // - payment=error ã¾ãŸã¯ payment=cancel ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
        // - ãã‚Œä»¥å¤–ã§ diagnosisId ãŒã‚ã‚‹å ´åˆã¯æˆåŠŸã¨ã¿ãªã™
        const showError = paymentStatus === 'error' || paymentStatus === 'cancel';
        const showSuccess = !showError && diagnosisId;
        
        if (showError) {
            document.querySelector('.header').style.background = 'linear-gradient(135deg, #f56565 0%, #c53030 100%)';
            document.querySelector('h1').textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            document.querySelector('.subtitle').textContent = 'æ±ºæ¸ˆå‡¦ç†ä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            document.querySelector('.message').innerHTML = `
                <p style="color: #e53e3e;">
                    ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚<br>
                    æ±ºæ¸ˆå‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸã€‚<br><br>
                    ãŠæ‰‹æ•°ã§ã™ãŒã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
                </p>
            `;
            viewResultBtn.style.display = 'none';
        } else if (!diagnosisId) {
            // diagnosisId ãŒãªã„å ´åˆã‚‚ã‚¨ãƒ©ãƒ¼
            document.querySelector('.header').style.background = 'linear-gradient(135deg, #f56565 0%, #c53030 100%)';
            document.querySelector('h1').textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            document.querySelector('.subtitle').textContent = 'ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™';
            document.querySelector('.message').innerHTML = `
                <p style="color: #e53e3e;">
                    è¨ºæ–­IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚<br><br>
                    LINEã‹ã‚‰ã€Œå±¥æ­´ã€ã¨é€ä¿¡ã—ã¦<br>
                    è¨ºæ–­çµæœã‚’ã”ç¢ºèªãã ã•ã„ã€‚
                </p>
            `;
            viewResultBtn.style.display = 'none';
        }
        
        // PayPayæ±ºæ¸ˆã®å ´åˆã€æ”¯æ‰•ã„æ–¹æ³•ã‚’æ›´æ–°ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨˜éŒ²
        if ((isPayPayRedirect || isFromPayPayApp || merchantPaymentId) && diagnosisId) {
            const paymentMethodElement = document.querySelector('.info-row:nth-child(2) .info-value');
            if (paymentMethodElement) {
                paymentMethodElement.textContent = 'PayPay';
            }
            // é‡‘é¡ã‚‚æ­£ã—ãæ›´æ–°
            const amountElement = document.querySelector('.info-row:last-child .info-value');
            if (amountElement) {
                amountElement.textContent = 'Â¥2,980';
            }
            
            // PayPayæ±ºæ¸ˆå®Œäº†ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¨˜éŒ²ï¼ˆpurchasesãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
            if (merchantPaymentId || isFromPayPayApp) {
                // å³åº§ã«è¨˜éŒ²ã‚’è©¦ã¿ã‚‹
                recordPayment();
                
                // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒå¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ãƒãƒ¼ãƒªãƒ³ã‚°ã‚‚å®Ÿæ–½
                if (isFromPayPayApp) {
                    // 3ç§’ã”ã¨ã«æœ€å¤§10å›ã¾ã§æ±ºæ¸ˆçŠ¶æ…‹ã‚’ç¢ºèª
                    let pollCount = 0;
                    const maxPolls = 10;
                    const pollInterval = setInterval(() => {
                        pollCount++;
                        if (pollCount > maxPolls) {
                            clearInterval(pollInterval);
                            return;
                        }
                        recordPayment();
                    }, 3000);
                }
            }
            
            function recordPayment() {
                fetch('/api/update-paypay-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        merchantPaymentId: merchantPaymentId,
                        diagnosisId: diagnosisId,
                        userId: userId
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        console.log('PayPay payment recorded:', data.purchaseId);
                        // æˆåŠŸã—ãŸã‚‰ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’åœæ­¢
                        if (typeof pollInterval !== 'undefined') {
                            clearInterval(pollInterval);
                        }
                    } else if (data.status === 'pending') {
                        console.log('Payment still pending...');
                    } else {
                        console.error('Failed to record payment:', data);
                    }
                })
                .catch(err => {
                    console.error('Error recording payment:', err);
                });
            }
        }
    </script>
</body>
</html>