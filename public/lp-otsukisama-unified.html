<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>おつきさま診断 - 月が導くあなたの運命</title>
    <link rel="stylesheet" href="css/lp-otsukisama.css">
    <style>
        /* プレビュー専用のスタイル */
        .preview-mode .form-section {
            display: none !important;
        }
        
        .preview-mode .result-section {
            display: block !important;
        }
        
        /* ぼかし効果とロックオーバーレイ */
        .preview-mode .content-locked {
            position: relative !important;
            min-height: 200px; /* 最小高さを確保 */
        }
        
        /* テキストコンテンツのみにblurを適用 */
        .preview-mode .text-blur {
            filter: blur(8px);
            user-select: none;
            pointer-events: none;
        }
        
        /* バナー画像とタイトルはモザイクを適用しない */
        .preview-mode .content-locked img[src*="/images/banner/"],
        .preview-mode .content-locked .section-header-container,
        .preview-mode .content-locked .fortune-banner-wrapper,
        .preview-mode .content-locked h2,
        .preview-mode .content-locked h3,
        .preview-mode .content-locked h4,
        .preview-mode .content-locked .moon-phase-header,
        .preview-mode .content-locked .tsukuyomi-section {
            filter: none !important;
            opacity: 1 !important;
            user-select: auto;
            pointer-events: auto;
        }
        
        .preview-mode .lock-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(138, 97, 250, 0.3);
            border: 2px solid rgba(138, 97, 250, 0.2);
            z-index: 100;
            filter: none;
            display: block;
            max-width: 280px;
            width: 80%;
        }
        
        .complete-mode .lock-overlay {
            display: none;
        }
        
        .complete-mode .content-locked {
            filter: none;
            user-select: auto;
            pointer-events: auto;
        }
        
        .lock-icon {
            font-size: 32px;
            display: block;
            margin-bottom: 10px;
        }
        
        .lock-overlay h3 {
            color: #4a3a8c;
            font-size: 20px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .lock-overlay p {
            color: #666;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        .lock-message {
            font-size: 12px !important;
            margin-bottom: 5px !important;
        }
        
        .unlock-button {
            background: linear-gradient(135deg, #8a61fa 0%, #c77dff 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .unlock-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(138, 97, 250, 0.4);
        }
        
        /* 小さめのCTAボタンスタイル */
        .purchase-button-mini {
            background: linear-gradient(135deg, #8a61fa 0%, #c77dff 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
            margin-top: 10px;
        }
        
        .purchase-button-mini:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(138, 97, 250, 0.4);
        }
        
        /* 小さなモザイクエリア用のスタイル */
        .content-locked-mini {
            position: relative;
            min-height: 100px;
        }
        
        .lock-overlay-mini {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
        }
        
        .preview-mode .lock-overlay-mini {
            display: block;
        }
        
        .complete-mode .lock-overlay-mini {
            display: none;
        }
        
        /* 有料コンテンツのラッパー */
        .premium-content-wrapper {
            position: relative;
        }
        
        /* CTAセクション */
        .preview-cta {
            background: linear-gradient(135deg, #f8f4ff 0%, #fff5fb 100%);
            padding: 60px 20px;
            margin: 60px 0;
            border-radius: 30px;
            text-align: center;
            border: 2px solid rgba(138, 97, 250, 0.1);
        }
        
        .complete-mode .preview-cta {
            display: none;
        }
        
        .preview-cta h2 {
            color: #4a3a8c;
            font-size: 28px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .preview-cta p {
            color: #666;
            font-size: 16px;
            margin-bottom: 30px;
            line-height: 1.8;
        }
        
        .price-info {
            margin: 30px 0;
        }
        
        .original-price {
            color: #999;
            text-decoration: line-through;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .special-price {
            font-size: 36px;
            color: #8a61fa;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .price-note {
            color: #666;
            font-size: 14px;
        }
        
        .purchase-button {
            background: linear-gradient(135deg, #8a61fa 0%, #c77dff 100%);
            color: white;
            border: none;
            padding: 20px 60px;
            border-radius: 30px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
            margin-top: 20px;
        }
        
        .purchase-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(138, 97, 250, 0.4);
        }
        
    </style>
</head>
<body class="preview-mode loading-active" id="pageBody">
    <!-- アクセシビリティ: スキップリンク -->
    
    <!-- ローディングオーバーレイ（最初から表示） -->
    <div class="loading-overlay" id="loadingOverlay" style="display: flex;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">診断結果を読み込んでいます...</div>
            <div class="loading-progress-container">
                <div class="loading-progress-bar" id="loadingProgress">
                    <span class="loading-moon-character">🌙</span>
                </div>
                <div class="loading-stars">
                    <span class="loading-star" style="left: 10%; animation-delay: 0s;">✨</span>
                    <span class="loading-star" style="left: 30%; animation-delay: 0.3s;">✨</span>
                    <span class="loading-star" style="left: 50%; animation-delay: 0.6s;">✨</span>
                    <span class="loading-star" style="left: 70%; animation-delay: 0.9s;">✨</span>
                    <span class="loading-star" style="left: 90%; animation-delay: 1.2s;">✨</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- スクロール進捗バー -->
    <div class="scroll-progress" id="scrollProgress"></div>
    <!-- 星空背景 -->
    <div class="stars-container" id="starsContainer"></div>
    
    <!-- メインコンテンツ -->
    <div class="container">
        <!-- ヘッダー -->
        <div class="header">
            <div class="main-moon"></div>
            <img src="/images/banner/1-title.png" alt="おつきさま診断" class="responsive-image">
            <p class="subtitle" id="pageSubtitle">診断結果（プレビュー版）</p>
            <p class="sub-description" id="pageDescription">
                一部の内容のみ表示されています
            </p>
        </div>
        
        <!-- 結果セクション -->
        <div class="result-section" id="resultSection">
            <!-- 月詠の挨拶 -->
            <div class="tsukuyomi-section">
                <div class="tsukuyomi-character">
                    <img src="/images/tsukuyomi/2.png" alt="月詠">
                </div>
                <div class="tsukuyomi-bubble">
                    <div class="tsukuyomi-name">月詠</div>
                    <p>
                        こんにちは、<span id="resultName"></span>さん。私は月詠（つくよみ）と申します。今夜の月が、あなたの運命を照らし出します。あなたが生まれた日の月は、特別な形をしていました。その月が持つメッセージを、今からお伝えしていきますね。
                    </p>
                </div>
            </div>
            
            <!-- タイプ診断タイトル -->
            <img src="/images/banner/2-anata.png" alt="おつきさま診断で読み解くあなた" class="full-width-banner">
            
            <!-- 月詠による診断説明 -->
            <div class="tsukuyomi-section right">
                <div class="tsukuyomi-character">
                    <img src="/images/tsukuyomi/4.png" alt="月詠">
                </div>
                <div class="tsukuyomi-bubble">
                    <div class="tsukuyomi-name">月詠</div>
                    <p>
                        さて、ここからが本題です。これから、あなたの生まれた日の月相を基に、6つの要素からあなたの本質を明らかにしていきます。まずは、この6つの要素が何を意味するのかご覧ください。
                    </p>
                </div>
            </div>
            
            <!-- 6つのタイプを円形配置 -->
            <div class="moon-types-circle">
                <!-- 軌道線 -->
                <div class="orbit-path"></div>
                
                <!-- 中心の月 -->
                <div class="center-moon"></div>
                
                <!-- 要素コンテナ -->
                <div class="elements-container">
                    <!-- 月相 (0度 - 上) -->
                    <div class="type-item moon-phase-item" data-position="0" data-moon-type="omote" data-moon-phase="0">
                        <img src="/images/moon/omote-0.png" alt="表月相" class="circle-element-image">
                        <span class="circle-element-label-top label-color-gold">月相</span>
                        <span class="circle-element-label-bottom">読み込み中...</span>
                    </div>
                    
                    <!-- 裏月相 (60度 - 右上) -->
                    <div class="type-item moon-phase-item" data-position="60" data-moon-type="ura" data-moon-phase="1">
                        <img src="/images/moon/ura-0.png" alt="裏月相" class="circle-element-image">
                        <span class="circle-element-label-top label-color-purple">裏月相</span>
                        <span class="circle-element-label-bottom">読み込み中...</span>
                    </div>
                    
                    <!-- 感情表現 (120度 - 右下) -->
                    <div class="type-item love-type-item" data-position="120" data-type="emotional" data-value="">
                        <img src="/images/love-types/emotional/straight.png" alt="感情表現" class="circle-element-image-contain">
                        <span class="circle-element-label-top label-color-pink">感情表現</span>
                        <span class="circle-element-label-bottom">...</span>
                    </div>
                    
                    <!-- 距離感 (180度 - 下) -->
                    <div class="type-item love-type-item" data-position="180" data-type="distance" data-value="">
                        <img src="/images/love-types/distance/close.png" alt="距離感" class="circle-element-image-contain">
                        <span class="circle-element-label-top label-color-green">距離感</span>
                        <span class="circle-element-label-bottom">...</span>
                    </div>
                    
                    <!-- 価値観 (240度 - 左下) -->
                    <div class="type-item love-type-item" data-position="240" data-type="values" data-value="">
                        <img src="/images/love-types/values/realistic.png" alt="価値観" class="circle-element-image-contain">
                        <span class="circle-element-label-top label-color-blue">価値観</span>
                        <span class="circle-element-label-bottom">...</span>
                    </div>
                    
                    <!-- エネルギー (300度 - 左上) -->
                    <div class="type-item love-type-item" data-position="300" data-type="energy" data-value="">
                        <img src="/images/love-types/energy/intense.png" alt="エネルギー" class="circle-element-image-contain">
                        <span class="circle-element-label-top label-color-orange">エネルギー</span>
                        <span class="circle-element-label-bottom">...</span>
                    </div>
                </div>
            </div>
            
            <p class="section-description">
                生まれた日の月相から読み解く、あなたの「本当の自分」
            </p>
            
            <!-- 月相説明セクション -->
            <div class="section-header-container">
                <img src="/images/banner/3-getsusou.png" alt="まずは、あなたの月相から見ていきましょう" class="full-width-banner">
                <p class="section-description">
                    月相とは、あなたが生まれた日の月の形。これによって、あなたの基本的な性格や人生のテーマがわかります。あなたの月相は...
                </p>
            </div>
            
            <!-- 月相タイプ -->
            <div class="moon-phase-card new-moon">
                <div class="moon-phase-header">
                    <img src="/images/moon/omote-0.png" alt="新月" class="moon-phase-visual moon-phase-image">
                    <div class="moon-phase-info">
                        <h2>新月</h2>
                        <p class="moon-phase-subtitle">新しい始まりの力。無限の可能性を秘めた開拓者</p>
                    </div>
                </div>
                <div class="moon-phase-description" id="moon-phase-description">
                    あなたは新月の日に生まれた、始まりのエネルギーを持つ人。何もないところから何かを生み出す力があり、ゼロから1を作り出すことに長けています。純粋で素直な心を持ち、新しいことへの好奇心が旺盛。まだ誰も踏み入れていない道を進むパイオニア精神があります。時に無鉄砲に見えることもありますが、その勇気こそがあなたの最大の武器なのです。
                </div>
            </div>
            
            <!-- 購入CTA（プレビューモードでのみ表示） -->
            <div class="preview-cta">
                <h2>🔒 完全版で全ての内容を見る</h2>
                <p>
                    以下の内容を含む、あなただけの完全な診断結果をご覧いただけます：
                </p>
                <ul style="text-align: left; max-width: 500px; margin: 0 auto; color: #666; line-height: 2;">
                    <li>裏の月相とあなたの隠された顔</li>
                    <li>3つの月の力の詳細解説</li>
                    <li>4つの軸から見た恋愛性格の完全分析</li>
                    <li>直近3ヶ月の詳細な運勢予測</li>
                    <li>恋愛運・人間関係運・仕事運・金運の完全版</li>
                    <li>あなただけの月齢カレンダー</li>
                    <li>月が教えてくれる5つの教え</li>
                </ul>
                
                <div class="price-info">
                    <div class="original-price">通常価格 ¥2,980</div>
                    <div class="special-price">特別価格 ¥980</div>
                    <div class="price-note">（税込）</div>
                </div>
                
                <button class="purchase-button" id="purchaseButton">
                    診断結果を購入する
                </button>
            </div>
        </div><!-- result-section終了 -->
            
        <!-- 以降の内容（プレミアムコンテンツ） -->
        <div class="premium-content-wrapper">
                <!-- 裏月相セクション -->
                <!-- 裏月相説明 -->
                <div class="section-header-container">
                    <img src="/images/banner/4-2-uranokao.png" alt="そして、あなたの裏の顔も見てみましょう" class="full-width-banner">
                    <p class="section-description-compact">
                        表の月相が社会的な顔だとすれば、裏月相はあなたのプライベートな顔。親しい人の前でだけ見せる、もう一つのあなたです。
                    </p>
                </div>
                
                <!-- 裏月相カード -->
                <div class="moon-phase-card crescent">
                    <div class="moon-phase-header">
                        <img src="/images/moon/ura-1.png" alt="三日月" class="moon-phase-visual moon-phase-image">
                        <div class="moon-phase-info">
                            <h2>三日月（裏の顔）</h2>
                            <p class="moon-phase-subtitle">内なる繊細さと慎重さを秘めた策士</p>
                        </div>
                    </div>
                    <div class="content-locked-mini">
                        <div class="text-blur">
                            <div class="moon-phase-description" id="hidden-phase-description">
                                表向きは勢いよく突き進むあなたですが、実は内面では細やかな配慮ができる繊細な人。新しいことを始める前に、実はしっかりと下調べをしていたり、リスクを計算していたりするでしょう。その慎重さと大胆さのバランスが、あなたの成功の秘訣。時々弱音を吐きたくなることもありますが、それは成長の証です。
                            </div>
                        </div>
                        <div class="lock-overlay-mini">
                            <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                        </div>
                    </div>
                </div>
                
                <!-- 3つの月の力セクション -->
                <div class="section-header-container">
                    <img src="/images/banner/5-1-3tsuno.png" alt="あなたが持っている3つの力は〇〇です" class="full-width-banner">
                    <p style="color: #ffffff; font-size: 18px; font-weight: 600; line-height: 2; text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">
                        さらに深く、あなたの月が持つ特別な力を見ていきましょう。月には3つの力があり、それぞれがあなたの人生を導いています。
                    </p>
                </div>
                
                <div class="content-locked-mini">
                    <div class="text-blur">
                        <div class="energy-types three-powers">
                            <div class="energy-item">
                                <div class="energy-title">直感力</div>
                                <div class="energy-description">
                                    第六感が鋭く、見えない危険を察知する能力があります。迷った時は、理屈より直感を信じることで正しい道を選べるでしょう。
                                </div>
                            </div>
                            <div class="energy-item">
                                <div class="energy-title">創造力</div>
                                <div class="energy-description">
                                    無から有を生み出す力。アイデアが湧き出る泉のような存在で、周りの人に新しい視点を与えることができます。
                                </div>
                            </div>
                            <div class="energy-item">
                                <div class="energy-title">浄化力</div>
                                <div class="energy-description">
                                    ネガティブなエネルギーを跳ね返し、周りの空気を清める力。あなたがいるだけで、場の雰囲気が明るくなります。
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="lock-overlay-mini">
                        <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                    </div>
                </div>
                
                <!-- 4つの軸からあなたを紐解く -->
                <div style="padding: 20px 0 10px; text-align: center;">
                    <img src="/images/banner/5-2-tikara.png" alt="4つの軸からあなたを紐解く" style="max-width: 100%; height: auto; margin-bottom: 5px;">
                    <p style="color: #ffffff; font-size: 18px; font-weight: 600; line-height: 2; text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">
                        次に、4つの軸から見たあなたの特性を見ていきます。
                    </p>
                </div>
                
                <div class="content-locked-mini">
                    <div class="text-blur">
                        <div class="love-type-grid">
                            <div class="love-type-card">
                                <div class="love-type-title">
                                    <img src="/images/love-types/emotional/straight.png" alt="ストレート型">
                                    感情表現：<span id="emotionalExpressionType">ストレート型</span>
                                </div>
                                <div class="love-type-content" id="emotionalExpressionContent">
                                    好きな人には素直に気持ちを伝えるタイプ。駆け引きは苦手で、思ったことがすぐ顔に出てしまいます。その純粋さが、相手の心を動かす最大の魅力。
                                </div>
                            </div>
                            <div class="love-type-card">
                                <div class="love-type-title">
                                    <img src="/images/love-types/distance/independent.png" alt="自由マイペース型">
                                    距離感：<span id="distanceStyleType">自由マイペース型</span>
                                </div>
                                <div class="love-type-content" id="distanceStyleContent">
                                    束縛されることを嫌い、自分のペースを大切にします。相手にも自由を与え、お互いに成長できる関係を理想とします。
                                </div>
                            </div>
                            <div class="love-type-card">
                                <div class="love-type-title">
                                    <img src="/images/love-types/values/romantic.png" alt="ロマンチスト型">
                                    価値観：<span id="loveValuesType">ロマンチスト型</span>
                                </div>
                                <div class="love-type-content" id="loveValuesContent">
                                </div>
                            </div>
                            <div class="love-type-card">
                                <div class="love-type-title">
                                    <img src="/images/love-types/energy/intense.png" alt="燃え上がり型">
                                    エネルギー：<span id="loveEnergyType">燃え上がり型</span>
                                </div>
                                <div class="love-type-content" id="loveEnergyContent">
                                    あなたは恋愛において、一気に感情が燃え上がるタイプです。
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="lock-overlay-mini">
                        <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                    </div>
                </div>
                
                <!-- 月詠による恋愛タイプ総括 -->
                <div class="tsukuyomi-section">
                    <div class="tsukuyomi-character">
                        <img src="/images/tsukuyomi/5.png" alt="月詠">
                    </div>
                    <div class="tsukuyomi-bubble">
                        <div class="tsukuyomi-name">月詠</div>
                        <p>
                            いかがでしたでしょうか。あなた自身、自覚していた面も、初めて意識した面もあったと思います。これらすべてが、あなたという月の持つ多面的な輝きなのです。
                        </p>
                    </div>
                </div>
                
                <!-- 運命のカレンダーセクション -->
                    <!-- 月詠による直近3ヶ月導入 -->
                    <div class="tsukuyomi-section right">
                        <div class="tsukuyomi-character">
                            <img src="/images/tsukuyomi/7.png" alt="月詠">
                        </div>
                        <div class="tsukuyomi-bubble">
                            <div class="tsukuyomi-name">月詠</div>
                            <p>
                                ここまで、あなたの月相、裏の顔、3つの月の力、そして4つの軸から見たあなたの本質を見てきました。これらすべてを踏まえて、いよいよ<span style="color: #ffd700; font-weight: bold; font-size: 20px;">直近3ヶ月のあなたに訪れる運命</span>を読み解いていきます。全体運から始まり、恋愛運、人間関係運、仕事運、金運...月のリズムが教えてくれる、あなただけの3ヶ月の集中的なストーリーをお届けしますね。
                            </p>
                        </div>
                    </div>
                    
                <!-- 総合恋愛タイプ診断 -->
                <div class="content-locked-mini">
                    <div class="text-blur">
                        <div id="combinedPersonality" style="margin: 40px 0;"></div>
                        
                        <!-- 相性の良いタイプ -->
                        <div id="compatibleTypes" style="margin: 30px 0;"></div>
                    </div>
                    <div class="lock-overlay-mini">
                        <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                    </div>
                </div>
                
                <!-- スターセパレーター -->
                <div class="star-separator"></div>
                
                <!-- 直近3ヶ月全体運バナー -->
                <img src="/images/banner/7-unmei.png" alt="直近3ヶ月の運命" style="max-width: 100%; height: auto; margin: 15px 0 5px;">
                
                <!-- 直近3ヶ月全体運 -->
                <div class="fortune-section destiny">
                    <div class="section-header">
                        <h2 class="rhythm-heading" id="fortune-overall-title">未決定</h2>
                        <p id="fortune-overall-intro"></p>
                    </div>
                    
                    <!-- 運勢グラフセクション（overall内に移動） -->
                    <div class="fortune-graph-section" style="margin: 30px 0;">
                        <div style="background: linear-gradient(135deg, rgba(20, 10, 50, 0.95), rgba(40, 20, 70, 0.95)); padding: 20px 15px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                            <h4 style="color: #ffd700; margin-bottom: 20px; text-align: center; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                                3ヶ月の運勢推移グラフ
                            </h4>
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div style="background: rgba(0, 0, 0, 0.2); border-radius: 10px; padding: 10px; position: relative;">
                                        <div style="height: 420px;">
                                            <canvas id="fortuneChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fortune-content">
                        <img src="/images/banner/overall-1.png" alt="直近3ヶ月の全体的な流れ" class="section-banner">
                        
                        <div class="content-locked-mini">
                            <div class="text-blur">
                                <div class="fortune-highlight">
                                    <p class="fortune-overall-text" id="fortune-overall-text"></p>
                                </div>
                            </div>
                            <div class="lock-overlay-mini">
                                <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                            </div>
                        </div>
                        
                        <!-- 1ヶ月目・2ヶ月目の展開と注意ポイントを削除 -->
                    </div>
                </div>
                
                <!-- 恋愛運セクション -->
                <!-- 月詠による恋愛運への移行 -->
                <div class="tsukuyomi-section">
                    <div class="tsukuyomi-character">
                        <img src="/images/tsukuyomi/7.png" alt="月詠">
                    </div>
                    <div class="tsukuyomi-bubble">
                        <div class="tsukuyomi-name">月詠</div>
                        <p>
                            全体運を踏まえて、次に気になるのは恋愛運ですね。直近3ヶ月、あなたの恋愛にはどんな展開が待っているのでしょうか。月の導きから、あなたの恋の行方を詳しく見ていきましょう。
                        </p>
                    </div>
                </div>
                
                <!-- 恋愛運バナー -->
                <div class="fortune-banner-wrapper">
                    <img src="/images/banner/8-rennai.png" alt="あなたの恋愛運" class="fortune-main-banner">
                    
                    <!-- 恋愛運 -->
                    <div class="fortune-section love">
                        <div class="fortune-content">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="fortune-highlight">
                                        <p class="fortune-love-text" id="fortune-love-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                            
                            <!-- 新規セクション：運命的な出会い -->
                            <img src="/images/banner/love-1.png" alt="あなたの心をときめかせる、運命的な出会いは訪れる？" class="section-banner">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="love-new-section hanging-text">
                                        <p id="fortune-love-destiny-meeting" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                            
                            <!-- 新規セクション：恋の矢を向けている相手 -->
                            <img src="/images/banner/love-2.png" alt="今後3ヶ月、あなたに恋の矢を向けているお相手はこんな人" class="section-banner">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="love-new-section hanging-text">
                                        <p id="fortune-love-admirer-type" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                            
                            <!-- 新規セクション：危険な異性のタイプ -->
                            <img src="/images/banner/love-3.png" alt="危険な恋の罠？この3ヶ月、あなたが出会うと危険な異性のタイプ" class="section-banner">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="love-new-section hanging-text">
                                        <p id="fortune-love-dangerous-type" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                            
                            <!-- 恋愛の注意ポイントを削除 -->
                        </div>
                    </div>
                </div>
                
                <!-- 人間関係運セクション -->
                <!-- 月詠による人間関係運への移行 -->
                <div class="tsukuyomi-section right">
                    <div class="tsukuyomi-character">
                        <img src="/images/tsukuyomi/4.png" alt="月詠">
                    </div>
                    <div class="tsukuyomi-bubble">
                        <div class="tsukuyomi-name">月詠</div>
                        <p>
                            恋愛運はいかがでしたか？さて、恋愛だけでなく、すべての人間関係も見ていきましょう。直近3ヶ月、あなたの周りにはどんな人が集まってくるのでしょうか。
                        </p>
                    </div>
                </div>
                
                <!-- 人間関係運 -->
                <div class="fortune-banner-wrapper">
                    <img src="/images/banner/9-ningenn.png" alt="あなたの人間関係運" class="fortune-main-banner">
                    
                    <div class="fortune-section relationship">
                        <div class="fortune-content">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="fortune-highlight">
                                        <p class="fortune-relationship-text" id="fortune-relationship-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                            
                            <!-- 新規セクション：新しい人間関係 -->
                            <img src="/images/banner/relation-1.png" alt="今後3ヶ月であなたが築くことになる、新しい人間関係とは" class="section-banner">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="relationship-new-section hanging-text">
                                        <p id="fortune-relationship-new-connections" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                            
                            <!-- 新規セクション：人間関係の転機 -->
                            <img src="/images/banner/relation-2.png" alt="人間関係の転機が訪れます。切るべき縁と繋ぐべき縁とは？" class="section-banner">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="relationship-new-section hanging-text">
                                        <p id="fortune-relationship-challenges" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                            
                            <!-- 人間関係の注意ポイントを削除 -->
                        </div>
                    </div>
                </div>
                
                <!-- 仕事運セクション -->
                <!-- 月詠による仕事運への移行 -->
                <div class="tsukuyomi-section">
                    <div class="tsukuyomi-character">
                        <img src="/images/tsukuyomi/3.png" alt="月詠">
                    </div>
                    <div class="tsukuyomi-bubble">
                        <div class="tsukuyomi-name">月詠</div>
                        <p>
                            人間関係の流れを踏まえて、次は仕事運を見ていきましょう。直近3ヶ月、あなたの仕事やキャリアにはどんな展開が待っているのでしょうか。
                        </p>
                    </div>
                </div>
                
                <!-- 仕事運 -->
                <div class="fortune-banner-wrapper">
                    <img src="/images/banner/10-shigoto.png" alt="あなたの仕事運" class="fortune-main-banner">
                    
                    <div class="fortune-section work">
                        <div class="fortune-content">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="fortune-highlight">
                                        <p class="fortune-work-text" id="fortune-work-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                            
                            <!-- 新規セクション：仕事での躍進チャンス -->
                            <img src="/images/banner/work-1.png" alt="仕事での躍進チャンスは今にも手に届きそう" class="section-banner">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="work-new-section hanging-text">
                                        <p id="fortune-work-new-talent" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                            
                            <!-- 新規セクション：避けるべき落とし穴 -->
                            <img src="/images/banner/work-2.png" alt="仕事で陥りがちな落とし穴" class="section-banner">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="work-new-section hanging-text">
                                        <p id="fortune-work-turning-point" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                            
                            <!-- 仕事の注意ポイントを削除 -->
                        </div>
                    </div>
                </div>
                
                <!-- 金運セクション -->
                <!-- 月詠による金運への移行 -->
                <div class="tsukuyomi-section right">
                    <div class="tsukuyomi-character">
                        <img src="/images/tsukuyomi/6.png" alt="月詠">
                    </div>
                    <div class="tsukuyomi-bubble">
                        <div class="tsukuyomi-name">月詠</div>
                        <p>
                            最後に、誰もが気になる金運を見ていきましょう。直近3ヶ月、あなたの財運にはどんな流れが訪れるのでしょうか。
                        </p>
                    </div>
                </div>
                
                <!-- 金運 -->
                <div class="fortune-banner-wrapper">
                    <img src="/images/banner/11-kin.png" alt="あなたの金運" class="fortune-main-banner">
                    
                    <div class="fortune-section money">
                        <div class="fortune-content">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="fortune-highlight">
                                        <p class="fortune-money-text" id="fortune-money-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                            
                            <!-- 新規セクション：ラッキーアクション -->
                            <img src="/images/banner/money-1.png" alt="あなたの金運を底上げする、とっておきのラッキーアクション" class="section-banner">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="money-new-section hanging-text">
                                        <p>
                                            新月の日に財布を新調し、満月の夜に財布を月光浴させると金運UP。月が欠けていく時期は無駄遣いを控え、毎月の新月と満月に財布を整理することが大切。
                                        </p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                            
                            <!-- 新規セクション：金銭トラブル回避 -->
                            <img src="/images/banner/money-2.png" alt="お金の貸し借りは慎重に。人間関係にヒビを入れる金銭問題" class="section-banner">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="money-new-section hanging-text">
                                        <p id="fortune-money-trouble" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 月詠による月齢カレンダーへの移行 -->
                <div class="tsukuyomi-section">
                    <div class="tsukuyomi-character">
                        <img src="/images/tsukuyomi/5.png" alt="月詠">
                    </div>
                    <div class="tsukuyomi-bubble">
                        <div class="tsukuyomi-name">月詠</div>
                        <p>
                            ここで特別なプレゼントがあります！恋愛運をさらに活かすために、あなただけの特別な月齢カレンダーをお伝えしますね。
                        </p>
                    </div>
                </div>
                
                <!-- 月齢カレンダー -->
                <div class="monthly-fortune">
                    <h4 style="color: #ffd700; font-size: 22px; text-align: center; margin-bottom: 20px; font-weight: bold; text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">
                        あなただけの月齢カレンダー（<span id="calendarMonthYear"></span>）
                    </h4>
                    <div class="content-locked-mini">
                        <div class="text-blur">
                            <div class="calendar-wrapper">
                                <div class="weekday-header">
                                    <div class="weekday">日</div>
                                    <div class="weekday">月</div>
                                    <div class="weekday">火</div>
                                    <div class="weekday">水</div>
                                    <div class="weekday">木</div>
                                    <div class="weekday">金</div>
                                    <div class="weekday">土</div>
                                </div>
                                <div id="personalizedCalendar" class="calendar-grid">
                                    <!-- JavaScriptで動的に生成 -->
                                </div>
                            </div>
                            <div class="calendar-legend">
                                <span class="legend-item"><span class="legend-dot lucky"></span>ラッキーデー</span>
                                <span class="legend-item"><span class="legend-dot power"></span>パワーデー</span>
                                <span class="legend-item"><span class="legend-dot caution"></span>注意日</span>
                            </div>
                            <p id="calendarMessage" style="color: #ffffff; text-align: center; margin-top: 20px; font-size: 16px; font-weight: 600; text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">
                                <!-- パターンごとのメッセージが動的に表示 -->
                            </p>
                        </div>
                        <div class="lock-overlay-mini">
                            <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                        </div>
                    </div>
                </div>
                
                <!-- 月詠による最終メッセージへの導入 -->
                <div class="tsukuyomi-section right">
                    <div class="tsukuyomi-character">
                        <img src="/images/tsukuyomi/2.png" alt="月詠">
                    </div>
                    <div class="tsukuyomi-bubble">
                        <div class="tsukuyomi-name">月詠</div>
                        <p>
                            ここまで長い診断でしたね。最後に、直近3ヶ月を幸せに過ごすための特別な鍵をお伝えします。
                        </p>
                    </div>
                </div>
                
                <!-- 最後のメッセージセクション -->
                <!-- 最終メッセージ -->
                <div class="final-message">
                    <!-- 「新月のあなたは」バナーを先に -->
                    <div style="margin-bottom: 30px;">
                        <img src="/images/banner/12-saigo.png" alt="月が教えてくれる5つの教え" style="max-width: 100%; height: auto; margin-bottom: 5px;">
                        <div class="content-locked-mini">
                            <div class="text-blur">
                                <p>
                                    新月のあなたは、常に新しいことへチャレンジする勇気を持っています。その勇気は素晴らしいものですが、時には立ち止まることも大切。月のリズムに合わせて、緩急をつけることで、より大きな成果を得られるでしょう。
                                </p>
                            </div>
                            <div class="lock-overlay-mini">
                                <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- その後に「最も重要なメッセージ」と「5つの教え」 -->
                    <img src="/images/banner/last.png" alt="月が教えてくれる最も重要なメッセージ" style="width: 100%; height: auto; margin-bottom: 20px;">
                    <div class="content-locked-mini">
                        <div class="text-blur">
                            <div>
                                <!-- 5つの教えをここに移動 -->
                                <div style="text-align: left; margin: 30px 0;">
                                    <div style="margin-bottom: 20px;">
                                        <strong style="color: #ffd700; font-size: 18px;">1. 新月の教え：「始める勇気を持ちなさい」</strong>
                                        失敗を恐れず、新しいことに挑戦する勇気。それがあなたの最大の武器です。
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <strong style="color: #ffd700; font-size: 18px;">2. 上弦の月の教え：「成長を楽しみなさい」</strong>
                                        困難も成長の糧。すべての経験があなたを強くします。
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <strong style="color: #ffd700; font-size: 18px;">3. 満月の教え：「感謝を忘れずに」</strong>
                                        成功した時こそ、周りへの感謝を。それが次の幸運を呼びます。
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <strong style="color: #ffd700; font-size: 18px;">4. 下弦の月の教え：「手放す勇気を」</strong>
                                        不要なものを手放すことで、新しいものが入ってきます。
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <strong style="color: #ffd700; font-size: 18px;">5. 闇月の教え：「休息も大切」</strong>
                                        時には立ち止まり、自分を見つめ直す時間も必要です。
                                    </div>
                                </div>
                                
                                <p style="margin-bottom: 20px;">
                                    月が教えてくれる最も重要なメッセージは、「すべては循環している」ということ。
                                </p>
                                
                                <p style="margin-bottom: 20px;">
                                    新月から満月へ、そしてまた新月へ。月が満ち欠けを繰り返すように、あなたの人生にも波があります。その波を受け入れ、流れに身を任せることで、本当の幸せを掴むことができるでしょう。
                                </p>
                                
                                <p style="margin-top: 30px;">
                                    <strong>最後に...</strong>直近3ヶ月、あなたは多くの「始まり」を経験します。その一つ一つが、あなたの人生を豊かにする種となるでしょう。
                                </p>
                                
                                <p>
                                    恐れずに一歩を踏み出してください。月はいつもあなたを見守り、導いています。
                                </p>
                                
                                <p style="color: #ffd700; font-size: 18px; margin-top: 30px;">
                                    <strong id="final-blessing-message">「新月の光があなたの道を照らしますように」</strong>
                                </p>
                            </div>
                        </div>
                        <div class="lock-overlay-mini">
                            <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                        </div>
                    </div>
                </div>
                    
                    <!-- 月詠の最終メッセージ -->
                    <div class="tsukuyomi-section">
                        <div class="tsukuyomi-character">
                            <img src="/images/tsukuyomi/9.png" alt="月詠">
                        </div>
                        <div class="tsukuyomi-bubble">
                            <div class="tsukuyomi-name">月詠</div>
                            <p>
                                長い診断でしたが、最後まで聞いてくださってありがとうございました。ここまで、あなたの月相、裏の顔、3つの月の力、4つの軸から見たあなたの本質、そして直近3ヶ月の運勢を見てきました。月の光は、あなたの内なる光を映し出す鏡。この診断を通して、あなたが本当の自分を見つけ、より輝かしい人生を歩むきっかけになれば幸いです。月のリズムと共に、素晴らしい日々をお過ごしくださいね。
                            </p>
                        </div>
                    </div>
                    
                    <!-- CTAセクション -->
                    <div class="cta-section">
                        <h3 class="cta-title">月詠とLINEで繋がる</h3>
                        <p class="cta-description">
                            毎日の月齢メッセージ、週間運勢グラフ、月相別開運アドバイスをお届けします。
                            今なら友だち追加で特別な月のメッセージをプレゼント！
                        </p>
                        <a href="https://lin.ee/egmCXoG" class="cta-button">🌙 LINE友だち追加する</a>
                    </div>
                </div>
        </div><!-- premium-content-wrapper終了 -->
    </div><!-- container終了 -->
    
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/otsukisama-data-loader.js?v=20250901001"></script>
    <script src="js/text-formatter.js?v=20250107001"></script>
    <script src="js/personality-type-mapper.js?v=20250107001"></script>
    <script src="js/lp-otsukisama-moon.js?v=20250901001"></script>
    <script src="js/lp-otsukisama-api.js?v=20250901001"></script>
    <script src="js/lp-otsukisama-display.js?v=20250107001"></script>
    <script src="js/lp-otsukisama-display-line.js?v=20250901001"></script>
    <script src="js/lp-otsukisama-calendar.js?v=20250901001"></script>
    <script src="js/lp-otsukisama-graph.js?v=20250901001"></script>
    
    <!-- lp-otsukisama-main.jsは統合版では使用しない（重複を避けるため） -->
    
    <script>
        // グローバル変数
        let currentPatternId = null;
        window.moonPhaseData = null;
        window.hiddenPhaseData = null;
        window.uiTexts = null;
        
        // データの読み込み
        async function loadDataFiles() {
            try {
                const [moonPhases, hiddenPhases, texts] = await Promise.all([
                    fetch('/data/moon-phase-descriptions.json').then(r => r.json()),
                    fetch('/data/hidden-phase-descriptions.json').then(r => r.json()),
                    fetch('/data/ui-texts.json').then(r => r.json())
                ]);
                
                window.moonPhaseData = moonPhases;
                window.hiddenPhaseData = hiddenPhases;
                window.uiTexts = texts;
                
                console.log('Data files loaded successfully');
                return true;
            } catch (error) {
                console.error('Failed to load data files:', error);
                return false;
            }
        }
        
        // スクロール進捗バーの更新
        function updateScrollProgress() {
            const scrollProgress = document.getElementById('scrollProgress');
            if (scrollProgress) {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                const scrollPercent = (scrollTop / scrollHeight) * 100;
                scrollProgress.style.width = scrollPercent + '%';
            }
        }
        
        // 表示モードを設定（APIレスポンスに基づいて動的に決定）
        function setDisplayMode(isPaid) {
            const pageBody = document.getElementById('pageBody');
            const pageSubtitle = document.getElementById('pageSubtitle');
            const pageDescription = document.getElementById('pageDescription');
            const loadingText = document.querySelector('.loading-text');
            
            if (isPaid) {
                // 完全版モード
                document.body.className = 'complete-mode';
                if (pageBody) pageBody.className = 'complete-mode';
                if (pageSubtitle) pageSubtitle.textContent = '月が導くあなたの運命';
                if (pageDescription) pageDescription.textContent = '生まれた日の月相から読み解く、あなただけの特別な運勢メッセージ';
                if (loadingText) {
                    loadingText.textContent = '診断結果を準備しています...';
                }
                // ページタイトルも更新
                document.title = 'おつきさま診断 - 月が導くあなたの運命';
                return 'complete';
            } else {
                // プレビューモード
                document.body.className = 'preview-mode';
                if (pageBody) pageBody.className = 'preview-mode';
                if (pageSubtitle) pageSubtitle.textContent = '診断結果（プレビュー版）';
                if (pageDescription) pageDescription.textContent = '一部の内容のみ表示されています';
                if (loadingText) {
                    loadingText.textContent = '診断結果を読み込んでいます...';
                }
                // ページタイトルも更新
                document.title = '診断結果プレビュー - おつきさま診断';
                return 'preview';
            }
        }
        
        // プレビュー・完全版統合の初期化関数
        async function initUnified() {
            const urlParams = new URLSearchParams(window.location.search);
            const diagnosisId = urlParams.get('id');
            
            // ローディングは既に表示されているので、進捗バーアニメーションのみ開始
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingProgress = document.getElementById('loadingProgress');
            
            // 進捗バーアニメーション
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress > 90) progress = 90; // 90%で一旦止める
                if (loadingProgress) {
                    loadingProgress.style.width = progress + '%';
                }
            }, 300);
            
            // データ読み込み完了時にクリア
            window.loadingProgressInterval = progressInterval;
            
            // 診断データを読み込み
            if (diagnosisId) {
                try {
                    console.log('診断データを取得中:', diagnosisId);
                    const userId = urlParams.get('userId');
                    const response = await fetch(`/api/profile-form-v2?action=get-diagnosis&id=${diagnosisId}&userId=${userId || ''}`);
                    const data = await response.json();
                    console.log('取得したデータ:', data);
                    
                    if (data.success && data.diagnosis) {
                        // アクセスレベルに基づいてモードを設定
                        const isPaid = data.accessLevel === 'full';
                        const mode = setDisplayMode(isPaid);
                        window.currentMode = mode;  // グローバルに保存
                        window.currentUserId = userId;  // ユーザーIDも保存
                        // 名前を表示
                        const resultName = document.getElementById('resultName');
                        if (resultName) {
                            resultName.textContent = data.diagnosis.user_name || 'あなた';
                        }
                        
                        // パターンIDをグローバル変数に設定
                        currentPatternId = data.diagnosis.moon_pattern_id || data.diagnosis.pattern_id;
                        
                        // 月相コンテンツを更新
                        if (typeof updateMoonPhaseContent === 'function') {
                            updateMoonPhaseContent(currentPatternId);
                        }
                        
                        // 月相を計算して表示
                        const moonPhaseIndex = Math.floor(currentPatternId / 8);
                        const hiddenPhaseIndex = currentPatternId % 8;
                        const moonPhaseNames = ['新月', '三日月', '上弦の月', '十三夜', '満月', '十六夜', '下弦の月', '暁'];
                        const moonPhase = moonPhaseNames[moonPhaseIndex];
                        const hiddenMoonPhase = moonPhaseNames[hiddenPhaseIndex];
                        
                        // 4つの軸データを設定（データベースから直接使用）
                        const loveProfile = {
                            emotionalExpression: data.diagnosis.emotional_expression,
                            distanceStyle: data.diagnosis.distance_style,
                            loveValues: data.diagnosis.love_values,
                            loveEnergy: data.diagnosis.love_energy
                        };
                        console.log('=== 4つの軸データ確認 ===');
                        console.log('Database values:', loveProfile);
                        console.log('API response:', data.diagnosis);
                        console.log('Access level:', data.accessLevel);
                        console.log('Cache version: 20250901001');
                        
                        
                        // 6つの要素を更新
                        if (typeof updateSixElements === 'function') {
                            // 常に全データを渡す（アクセス制限を一旦無効化）
                            updateSixElements(currentPatternId, moonPhase, hiddenMoonPhase, loveProfile);
                        }
                        
                        // 4つの軸データを表示（常に表示）
                        if (typeof updatePersonalityDisplay === 'function') {
                            console.log('Calling updatePersonalityDisplay with:', loveProfile);
                            await updatePersonalityDisplay(loveProfile);
                            console.log('updatePersonalityDisplay completed');
                        } else {
                            console.error('updatePersonalityDisplay is not defined');
                        }
                        
                        // エネルギーコンテンツを更新（常に表示）
                        if (typeof updateLoveEnergyContent === 'function' && loveProfile.loveEnergy) {
                            await updateLoveEnergyContent(loveProfile.loveEnergy);
                        }
                        
                        // 運勢コンテンツを更新（全体運、恋愛運、人間関係運、仕事運、金運）
                        // データローダーが準備できているか確認
                        if (window.OtsukisamaDataLoader && window.OtsukisamaDataLoader.isLoaded()) {
                            const pattern = window.OtsukisamaDataLoader.getPatternFortune(currentPatternId);
                            console.log('Pattern data for fortune:', pattern);
                            if (pattern && typeof updateDynamicContentFromPattern === 'function') {
                                updateDynamicContentFromPattern(pattern);
                            }
                        } else {
                            // データローダーの読み込みを待ってから再試行
                            window.addEventListener('otsukisama-data-loaded', () => {
                                const pattern = window.OtsukisamaDataLoader.getPatternFortune(currentPatternId);
                                console.log('Pattern data for fortune (after wait):', pattern);
                                if (pattern && typeof updateDynamicContentFromPattern === 'function') {
                                    updateDynamicContentFromPattern(pattern);
                                }
                            }, { once: true });
                        }
                        
                        // グラフを初期化（常に表示） - 少し遅延を入れて確実に実行
                        setTimeout(async () => {
                            if (typeof updateFortuneGraph === 'function') {
                                console.log('Initializing fortune graph for pattern:', currentPatternId);
                                await updateFortuneGraph(currentPatternId);
                            } else {
                                console.error('updateFortuneGraph function not found');
                            }
                        }, 100);
                        
                        // カレンダーを初期化（常に表示） - 少し遅延を入れて確実に実行
                        setTimeout(async () => {
                            if (typeof generatePersonalizedCalendar === 'function') {
                                console.log('Initializing calendar for pattern:', currentPatternId);
                                await generatePersonalizedCalendar(currentPatternId);
                            } else {
                                console.error('generatePersonalizedCalendar function not found');
                            }
                        }, 200);
                        
                        console.log('データ表示完了');
                    } else {
                        console.error('診断データが取得できませんでした:', data);
                    }
                } catch (error) {
                    console.error('診断データの読み込みエラー:', error);
                } finally {
                    // ローディングを非表示（進捗バーを100%にしてから）
                    if (loadingOverlay) {
                        // 進捗バーを100%に
                        if (loadingProgress) {
                            loadingProgress.style.width = '100%';
                        }
                        // インターバルをクリア
                        if (window.loadingProgressInterval) {
                            clearInterval(window.loadingProgressInterval);
                        }
                        setTimeout(() => {
                            loadingOverlay.style.display = 'none';
                            document.body.classList.remove('loading-active');
                        }, 500);
                    }
                }
            } else {
                // 診断IDがない場合もローディングを非表示
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                    document.body.classList.remove('loading-active');
                    if (window.loadingProgressInterval) {
                        clearInterval(window.loadingProgressInterval);
                    }
                }
            }
            
            // プレビューモードの場合、購入ボタンの設定
            if (window.currentMode !== 'complete') {
                const purchaseButton = document.getElementById('purchaseButton');
                if (purchaseButton) {
                    purchaseButton.addEventListener('click', async () => {
                        // 決済選択画面へリダイレクト
                        const diagnosisId = urlParams.get('id');
                        const userId = urlParams.get('userId');
                        window.location.href = `/payment-select.html?id=${diagnosisId}&userId=${userId || ''}`;
                    });
                }
                
            }
        }
        
        // 購入処理を実行する関数
        async function scrollToPayment() {
            const urlParams = new URLSearchParams(window.location.search);
            const diagnosisId = urlParams.get('id');
            const userId = window.currentUserId || 'anonymous';
            
            // PayPay決済画面へリダイレクト
            window.location.href = `/payment-select.html?id=${diagnosisId}&userId=${userId}`;
        }
        
        // DOMロード後に初期化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM Content Loaded - Initializing unified page...');
            
            // データファイルを読み込み
            await loadDataFiles();
            
            // データローダーの読み込みを待つ
            if (!window.OtsukisamaDataLoader || !window.OtsukisamaDataLoader.isLoaded()) {
                console.log('データローダーの読み込みを待機中...');
                await new Promise(resolve => {
                    window.addEventListener('otsukisama-data-loaded', resolve, { once: true });
                });
                console.log('データローダー読み込み完了');
            }
            
            // URLパラメータから診断IDとユーザーIDを取得
            const urlParams = new URLSearchParams(window.location.search);
            const diagnosisId = urlParams.get('id');
            const userId = urlParams.get('userId');
            
            // 診断データを取得して表示
            if (diagnosisId) {
                try {
                    const response = await fetch(`/api/profile-form-v2?action=get-diagnosis&id=${diagnosisId}`);
                    const data = await response.json();
                    
                    if (data.success && data.diagnosis) {
                        console.log('診断データ取得成功:', data.diagnosis);
                        
                        // 月相パターンIDを設定
                        if (typeof currentPatternId !== 'undefined') {
                            currentPatternId = data.diagnosis.moon_pattern_id || data.diagnosis.pattern_id;
                            
                            // 月相コンテンツを更新
                            if (typeof updateMoonPhaseContent === 'function') {
                                updateMoonPhaseContent(currentPatternId);
                            }
                            
                            // パターンIDから月相を計算
                            const moonPhaseIndex = Math.floor(currentPatternId / 8);
                            const hiddenPhaseIndex = currentPatternId % 8;
                            const moonPhaseNames = ['新月', '三日月', '上弦の月', '十三夜', '満月', '十六夜', '下弦の月', '暁'];
                            const moonPhase = moonPhaseNames[moonPhaseIndex];
                            const hiddenMoonPhase = moonPhaseNames[hiddenPhaseIndex];
                            
                            // 6つの要素を更新（4つの軸データを含む）
                            if (typeof updateSixElements === 'function') {
                                const profile = {
                                    emotionalExpression: data.diagnosis.emotional_expression,
                                    distanceStyle: data.diagnosis.distance_style,
                                    loveValues: data.diagnosis.love_values,
                                    loveEnergy: data.diagnosis.love_energy,
                                    userName: data.diagnosis.user_name
                                };
                                updateSixElements(currentPatternId, moonPhase, hiddenMoonPhase, profile);
                            }
                            
                            // グラフデータも更新
                            if (typeof updateFortuneGraph === 'function') {
                                updateFortuneGraph(currentPatternId);
                            }
                            
                            // 4つの軸の結果を更新
                            if (typeof updatePersonalityDisplay === 'function') {
                                const profile = {
                                    emotionalExpression: data.diagnosis.emotional_expression,
                                    distanceStyle: data.diagnosis.distance_style,
                                    loveValues: data.diagnosis.love_values,
                                    loveEnergy: data.diagnosis.love_energy,
                                    userName: data.diagnosis.user_name
                                };
                                updatePersonalityDisplay(profile);
                            }
                            
                            // 組み合わせ診断文を生成して表示
                            if (typeof displayCombinedPersonality === 'function') {
                                const profile = {
                                    emotionalExpression: data.diagnosis.emotional_expression,
                                    distanceStyle: data.diagnosis.distance_style,
                                    loveValues: data.diagnosis.love_values,
                                    loveEnergy: data.diagnosis.love_energy,
                                    userName: data.diagnosis.user_name
                                };
                                displayCombinedPersonality(profile);
                            }
                        }
                    }
                } catch (error) {
                    console.error('診断データ取得エラー:', error);
                }
            }
            
            // ユーザープロファイルも読み込む（互換性のため）
            if (userId && typeof loadUserProfile === 'function') {
                await loadUserProfile();
            }
            
            // 星空背景を生成
            const starsContainer = document.getElementById('starsContainer');
            if (starsContainer && !starsContainer.children.length) {
                for (let i = 0; i < 100; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    star.style.animationDelay = Math.random() * 3 + 's';
                    star.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    starsContainer.appendChild(star);
                }
            }
            
            // スクロール進捗バーの設定
            window.addEventListener('scroll', updateScrollProgress);
            
            // 統合初期化を実行
            await initUnified();
        });
    </script>

    <!-- フッターセクション -->
    <footer style="
        background: linear-gradient(135deg, #0a001a 0%, #1a0033 100%);
        padding: 60px 20px 30px;
        margin-top: 100px;
        border-top: 1px solid rgba(255, 215, 0, 0.2);
    ">
        <div style="
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        ">
            <!-- 免責事項 -->
            <div style="
                margin-bottom: 40px;
                padding: 30px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 15px;
                border: 1px solid rgba(255, 215, 0, 0.1);
            ">
                <h3 style="
                    color: #ffd700;
                    font-size: 18px;
                    margin-bottom: 15px;
                    font-weight: bold;
                ">ご利用にあたっての注意事項</h3>
                <p style="
                    color: rgba(255, 255, 255, 0.8);
                    font-size: 12px;
                    line-height: 1.8;
                    text-align: left;
                ">
                    ※ 本サービスは占い・エンターテインメントを目的としたものであり、科学的根拠に基づく医学的・心理学的な診断ではありません。<br>
                    ※ 診断結果は参考程度にお楽しみください。<br>
                    ※ デジタルコンテンツの性質上、購入後の返品・交換はお受けしておりません。<br>
                    ※ 診断結果に基づく行動により生じた損害について、当社は一切責任を負いません。
                </p>
            </div>
            
            <!-- リンク集 -->
            <div style="
                margin-bottom: 30px;
                display: flex;
                justify-content: center;
                gap: 30px;
                flex-wrap: wrap;
            ">
                <a href="/tokusho.html" style="
                    color: #ffd700;
                    text-decoration: none;
                    font-size: 14px;
                    transition: opacity 0.3s;
                " onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
                    特定商取引法に基づく表記
                </a>
                <a href="/privacy-policy.html" style="
                    color: #ffd700;
                    text-decoration: none;
                    font-size: 14px;
                    transition: opacity 0.3s;
                " onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
                    プライバシーポリシー
                </a>
                <a href="/contact.html" style="
                    color: #ffd700;
                    text-decoration: none;
                    font-size: 14px;
                    transition: opacity 0.3s;
                " onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
                    お問い合わせ
                </a>
            </div>
            
            <!-- コピーライト -->
            <div style="
                padding-top: 20px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                color: rgba(255, 255, 255, 0.5);
                font-size: 12px;
            ">
                <p>© 2025 おつきさま診断 | MiNTs株式会社</p>
                <p style="margin-top: 5px;">All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>