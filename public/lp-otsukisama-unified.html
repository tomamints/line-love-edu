<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>おつきさま診断 - 月が導くあなたの運命</title>
    <link rel="stylesheet" href="css/lp-otsukisama.css">
    <link rel="stylesheet" href="css/calendar-new.css">
    <script>
        // WebP対応チェックとフォールバック機能
        function supportsWebP() {
            const canvas = document.createElement('canvas');
            canvas.width = 1;
            canvas.height = 1;
            return canvas.toDataURL('image/webp').indexOf('image/webp') === 0;
        }

        function getImagePath(originalPath) {
            if (!supportsWebP()) {
                return originalPath;
            }

            // WebP版が存在する可能性のある画像形式の場合、WebP版を返す
            if (originalPath.match(/\.(jpg|jpeg|png)$/i)) {
                return originalPath.replace(/\.(jpg|jpeg|png)$/i, '.webp');
            }

            return originalPath;
        }

        // ページ読み込み後に全ての画像を処理
        document.addEventListener('DOMContentLoaded', function() {
            if (supportsWebP()) {
                // すべてのimg要素のsrcを更新
                document.querySelectorAll('img').forEach(img => {
                    const originalSrc = img.src || img.getAttribute('src');
                    if (originalSrc && originalSrc.match(/\.(jpg|jpeg|png)$/i)) {
                        const webpSrc = originalSrc.replace(/\.(jpg|jpeg|png)$/i, '.webp');

                        // WebP画像の存在を確認
                        const testImg = new Image();
                        testImg.onload = function() {
                            img.src = webpSrc;
                        };
                        testImg.onerror = function() {
                            // WebP版が存在しない場合は元の画像を使用
                            // console.log('WebP not found, using original:', originalSrc);
                        };
                        testImg.src = webpSrc;
                    }
                });
            }
        });
    </script>
    <style>
        /* プレビュー専用のスタイル */
        .preview-mode .form-section {
            display: none !important;
        }

        .preview-mode .result-section {
            display: block !important;
        }

        /* ぼかし効果とロックオーバーレイ */
        .preview-mode .content-locked {
            position: relative !important;
            min-height: 200px; /* 最小高さを確保 */
        }

        /* テキストコンテンツのみにblurを適用 */
        .preview-mode .text-blur {
            filter: blur(8px);
            user-select: none;
            pointer-events: none;
        }

        /* バナー画像とタイトルはモザイクを適用しない */
        .preview-mode .content-locked img[src*="/images/banner/"],
        .preview-mode .content-locked .section-header-container,
        .preview-mode .content-locked .fortune-banner-wrapper,
        .preview-mode .content-locked h2,
        .preview-mode .content-locked h3,
        .preview-mode .content-locked h4,
        .preview-mode .content-locked .moon-phase-header,
        .preview-mode .content-locked .tsukuyomi-section {
            filter: none !important;
            opacity: 1 !important;
            user-select: auto;
            pointer-events: auto;
        }

        .preview-mode .lock-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(138, 97, 250, 0.3);
            border: 2px solid rgba(138, 97, 250, 0.2);
            z-index: 100;
            filter: none;
            display: block;
            max-width: 280px;
            width: 80%;
        }

        .complete-mode .lock-overlay {
            display: none;
        }

        .complete-mode .content-locked {
            filter: none;
            user-select: auto;
            pointer-events: auto;
        }

        .lock-icon {
            font-size: 32px;
            display: block;
            margin-bottom: 10px;
        }

        .lock-overlay h3 {
            color: #4a3a8c;
            font-size: 20px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .lock-overlay p {
            color: #666;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .lock-message {
            font-size: 12px !important;
            margin-bottom: 5px !important;
        }

        .unlock-button {
            background: linear-gradient(135deg, #8a61fa 0%, #c77dff 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .unlock-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(138, 97, 250, 0.4);
        }

        /* 小さめのCTAボタンスタイル */
        .purchase-button-mini {
            background: linear-gradient(135deg, #8a61fa 0%, #c77dff 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
            margin-top: 10px;
        }

        .purchase-button-mini:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(138, 97, 250, 0.4);
        }

        /* 小さなモザイクエリア用のスタイル */
        .content-locked-mini {
            position: relative;
            min-height: 60px;
            margin: 15px 0;
        }

        /* 恋愛運セクションのバナーと枠を繋げる */
        .love-section-box {
            margin-top: 0 !important;
        }

        .lock-overlay-mini {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
        }

        .preview-mode .lock-overlay-mini {
            display: block;
        }

        .complete-mode .lock-overlay-mini {
            display: none;
        }

        /* 有料コンテンツのラッパー */
        .premium-content-wrapper {
            position: relative;
        }

        /* CTAセクション */
        .preview-cta {
            background: linear-gradient(135deg, #f8f4ff 0%, #fff5fb 100%);
            padding: 60px 20px;
            margin: 60px 0;
            border-radius: 30px;
            text-align: center;
            border: 2px solid rgba(138, 97, 250, 0.1);
        }

        .complete-mode .preview-cta {
            display: none;
        }

        .preview-cta h2 {
            color: #4a3a8c;
            font-size: 28px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .preview-cta p {
            color: #666;
            font-size: 16px;
            margin-bottom: 30px;
            line-height: 1.8;
        }

        /* プレビュー機能リストのスタイル */
        .preview-features-list {
            text-align: left;
            max-width: 500px;
            margin: 30px auto;
            padding: 0;
            list-style: none;
        }

        .preview-features-list li {
            color: #4a4a4a;
            line-height: 2.2;
            padding: 12px 20px;
            margin-bottom: 8px;
            position: relative;
            background: transparent;
            border-left: 3px solid rgba(138, 97, 250, 0.3);
            padding-left: 35px;
            transition: all 0.3s ease;
        }

        .preview-features-list li:hover {
            background: rgba(138, 97, 250, 0.05);
            border-left-color: rgba(138, 97, 250, 0.6);
            padding-left: 40px;
        }

        .preview-features-list li::before {
            content: "✨";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }

        /* スマホ表示用 */
        @media (max-width: 480px) {
            .preview-features-list {
                max-width: 100%;
                margin: 20px auto;
            }

            .preview-features-list li {
                font-size: 14px;
                padding: 10px 15px 10px 30px;
                margin-bottom: 6px;
            }

            .preview-features-list li::before {
                font-size: 14px;
                left: 8px;
            }
        }

        .price-info {
            margin: 30px 0;
        }

        .original-price {
            color: #999;
            text-decoration: line-through;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .special-price {
            font-size: 36px;
            color: #8a61fa;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .price-note {
            color: #666;
            font-size: 14px;
        }

        .purchase-button {
            background: linear-gradient(135deg, #8a61fa 0%, #c77dff 100%);
            color: white;
            border: none;
            padding: 20px 60px;
            border-radius: 30px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
            margin-top: 20px;
        }

        .purchase-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(138, 97, 250, 0.4);
        }

    </style>
</head>
<body class="preview-mode loading-active" id="pageBody">
    <!-- アクセシビリティ: スキップリンク -->

    <!-- ローディングオーバーレイ（最初から表示） -->
    <div class="loading-overlay" id="loadingOverlay" style="display: flex;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">診断結果を読み込んでいます...</div>
            <div class="loading-progress-container">
                <div class="loading-progress-bar" id="loadingProgress">
                    <span class="loading-moon-character">🌙</span>
                </div>
                <div class="loading-stars">
                    <span class="loading-star" style="left: 10%; animation-delay: 0s;">✨</span>
                    <span class="loading-star" style="left: 30%; animation-delay: 0.3s;">✨</span>
                    <span class="loading-star" style="left: 50%; animation-delay: 0.6s;">✨</span>
                    <span class="loading-star" style="left: 70%; animation-delay: 0.9s;">✨</span>
                    <span class="loading-star" style="left: 90%; animation-delay: 1.2s;">✨</span>
                </div>
            </div>
        </div>
    </div>

    <!-- スクロール進捗バー -->
    <div class="scroll-progress" id="scrollProgress"></div>
    <!-- 星空背景 -->
    <div class="stars-container" id="starsContainer"></div>

    <!-- メインコンテンツ -->
    <div class="container">
        <!-- ヘッダー -->
        <div class="header">
            <div class="main-moon"></div>
            <img src="/images/banner/1-title.png" alt="おつきさま診断" class="responsive-image">
            <img src="/images/banner/moon-guides-destiny.png" alt="月が導くあなたの運命" class="responsive-image" style="margin-top: 20px; width: 100%;">
        </div>

        <!-- 結果セクション -->
        <div class="result-section" id="resultSection">
            <!-- 月詠の挨拶 -->
            <div class="tsukuyomi-section">
                <div class="tsukuyomi-character">
                    <img src="/images/tsukuyomi/2.png" alt="月詠">
                </div>
                <div class="tsukuyomi-bubble">
                    <div class="tsukuyomi-name">月詠</div>
                    <p>
                        こんにちは、<span id="resultName"></span>さん。私は月詠（つくよみ）と申します。今夜の月が、あなたの運命を照らし出します。あなたが生まれた日の月は、特別な形をしていました。その月が持つメッセージを、今からお伝えしていきますね。
                    </p>
                </div>
            </div>


            <!-- 月詠による診断説明 -->
            <div class="tsukuyomi-section right">
                <div class="tsukuyomi-character">
                    <img src="/images/tsukuyomi/4.png" alt="月詠">
                </div>
                <div class="tsukuyomi-bubble">
                    <div class="tsukuyomi-name">月詠</div>
                    <p>
                        さて、ここからが本題です。これから、あなたの生まれた日の月相を基に、6つの要素からあなたの本質を明らかにしていきます。まずは、この6つの要素が何を意味するのかご覧ください。
                    </p>
                </div>
            </div>

            <!-- 6つのタイプを円形配置 -->
            <div class="moon-types-circle">
                <!-- 軌道線 -->
                <div class="orbit-path"></div>

                <!-- 中心の月 -->
                <div class="center-moon"></div>

                <!-- 要素コンテナ -->
                <div class="elements-container">
                    <!-- 月相 (0度 - 上) -->
                    <div class="type-item moon-phase-item" data-position="0" data-moon-type="omote" data-moon-phase="0">
                        <img src="/images/moon/omote-0.png" alt="表月相" class="circle-element-image">
                        <span class="circle-element-label-top label-color-gold">月相</span>
                        <span class="circle-element-label-bottom">読み込み中...</span>
                    </div>

                    <!-- 裏月相 (60度 - 右上) -->
                    <div class="type-item moon-phase-item" data-position="60" data-moon-type="ura" data-moon-phase="1">
                        <img src="/images/moon/ura-0.png" alt="裏月相" class="circle-element-image">
                        <span class="circle-element-label-top label-color-purple">裏月相</span>
                        <span class="circle-element-label-bottom">読み込み中...</span>
                    </div>

                    <!-- 感情表現 (120度 - 右下) -->
                    <div class="type-item love-type-item" data-position="120" data-type="emotional" data-value="">
                        <img src="/images/love-types/emotional/straight.png" alt="感情表現" class="circle-element-image-contain">
                        <span class="circle-element-label-top label-color-pink">感情表現</span>
                        <span class="circle-element-label-bottom">...</span>
                    </div>

                    <!-- 距離感 (180度 - 下) -->
                    <div class="type-item love-type-item" data-position="180" data-type="distance" data-value="">
                        <img src="/images/love-types/distance/close.png" alt="距離感" class="circle-element-image-contain">
                        <span class="circle-element-label-top label-color-green">距離感</span>
                        <span class="circle-element-label-bottom">...</span>
                    </div>

                    <!-- 価値観 (240度 - 左下) -->
                    <div class="type-item love-type-item" data-position="240" data-type="values" data-value="">
                        <img src="/images/love-types/values/realistic.png" alt="価値観" class="circle-element-image-contain">
                        <span class="circle-element-label-top label-color-blue">価値観</span>
                        <span class="circle-element-label-bottom">...</span>
                    </div>

                    <!-- エネルギー (300度 - 左上) -->
                    <div class="type-item love-type-item" data-position="300" data-type="energy" data-value="">
                        <img src="/images/love-types/energy/intense.png" alt="エネルギー" class="circle-element-image-contain">
                        <span class="circle-element-label-top label-color-orange">エネルギー</span>
                        <span class="circle-element-label-bottom">...</span>
                    </div>
                </div>
            </div>

            <img src="/images/banner/birth-moon-true-self.png" alt="生まれた日の月相から読み解く、あなたの「本当の自分」" class="full-width-banner" style="margin: 20px 0;">

            <!-- 月相説明セクション -->
            <div class="section-header-container">
                <img src="/images/banner/3-getsusou.png" alt="まずは、あなたの月相から見ていきましょう" class="full-width-banner">
                <p class="section-description">
                    月相とは、あなたが生まれた日の月の形。これによって、あなたの基本的な性格や人生のテーマがわかります。あなたの月相は...
                </p>
            </div>

            <!-- 月相タイプ -->
            <div class="moon-phase-card new-moon">
                <div class="moon-phase-header">
                    <img src="/images/moon/omote-0.png" alt="新月" class="moon-phase-visual moon-phase-image">
                    <div class="moon-phase-info">
                        <h2>新月</h2>
                        <p class="moon-phase-subtitle">新しい始まりの力。無限の可能性を秘めた開拓者</p>
                    </div>
                </div>
                <div class="moon-phase-description" id="moon-phase-description">
                    あなたは新月の日に生まれた、始まりのエネルギーを持つ人。何もないところから何かを生み出す力があり、ゼロから1を作り出すことに長けています。純粋で素直な心を持ち、新しいことへの好奇心が旺盛。まだ誰も踏み入れていない道を進むパイオニア精神があります。時に無鉄砲に見えることもありますが、その勇気こそがあなたの最大の武器なのです。
                </div>
            </div>

            <!-- 購入CTA（プレビューモードでのみ表示） -->
            <div class="preview-cta">
                <h2>🔒 完全版で全ての内容を見る</h2>
                <p>
                    以下の内容を含む、あなただけの完全な診断結果をご覧いただけます：
                </p>
                <ul class="preview-features-list">
                    <li>裏の月相とあなたの隠された顔</li>
                    <li>3つの月の力の詳細解説</li>
                    <li>4つの軸から見た恋愛性格の完全分析</li>
                    <li>直近3ヶ月の詳細な運勢予測</li>
                    <li>恋愛運・人間関係運・仕事運・金運の完全版</li>
                    <li>あなただけの月齢カレンダー</li>
                    <li>月が教えてくれる5つの教え</li>
                </ul>

                <div class="price-info">
                    <div class="original-price">通常価格 ¥2,980</div>
                    <div class="special-price">特別価格 ¥980</div>
                    <div class="price-note">（税込）</div>
                </div>

                <button class="purchase-button" id="purchaseButton">
                    診断結果を購入する
                </button>
            </div>
        </div><!-- result-section終了 -->

        <!-- 以降の内容（プレミアムコンテンツ） -->
        <div class="premium-content-wrapper">
                <!-- 裏月相セクション -->
                <!-- 裏月相説明 -->
                <div class="section-header-container">
                    <img src="/images/banner/hidden-moon-explanation.png" alt="そして、あなたの裏の顔も見てみましょう" class="full-width-banner">
                </div>

                <!-- 裏月相カード -->
                <div class="moon-phase-card crescent" id="hidden-phase-card">
                    <!-- コンテンツはJavaScriptで動的に生成 -->
                </div>

                <!-- 3つの月の力セクション -->
                <div class="section-header-container">
                    <img src="/images/banner/deeper-moon-powers.png" alt="あなたが持っている3つの力は〇〇です" class="full-width-banner">
                </div>

                <div class="content-locked-mini">
                    <div class="text-blur">
                        <div class="energy-types three-powers" id="threePowersContainer">
                            <div class="energy-item">
                                <div class="energy-title">直感力</div>
                                <div class="energy-description">
                                    第六感が鋭く、見えない危険を察知する能力があります。迷った時は、理屈より直感を信じることで正しい道を選べるでしょう。
                                </div>
                            </div>
                            <div class="energy-item">
                                <div class="energy-title">創造力</div>
                                <div class="energy-description">
                                    無から有を生み出す力。アイデアが湧き出る泉のような存在で、周りの人に新しい視点を与えることができます。
                                </div>
                            </div>
                            <div class="energy-item">
                                <div class="energy-title">浄化力</div>
                                <div class="energy-description">
                                    ネガティブなエネルギーを跳ね返し、周りの空気を清める力。あなたがいるだけで、場の雰囲気が明るくなります。
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="lock-overlay-mini">
                        <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                    </div>
                </div>

                <!-- 4つの軸からあなたを紐解く -->
                <div style="padding: 20px 0 10px; text-align: center;">
                    <img src="/images/banner/four-axes-analysis.png" alt="4つの軸からあなたを紐解く" style="max-width: 100%; height: auto; margin-bottom: 5px;">
                </div>

                <div class="content-locked-mini">
                    <div class="text-blur">
                        <div class="love-type-grid">
                            <div class="love-type-card">
                                <div class="love-type-title">
                                    <img src="/images/love-types/emotional/straight.png" alt="ストレート型">
                                    感情表現：<span id="emotionalExpressionType">ストレート型</span>
                                </div>
                                <div class="love-type-content" id="emotionalExpressionContent">
                                    好きな人には素直に気持ちを伝えるタイプ。駆け引きは苦手で、思ったことがすぐ顔に出てしまいます。その純粋さが、相手の心を動かす最大の魅力。
                                </div>
                            </div>
                            <div class="love-type-card">
                                <div class="love-type-title">
                                    <img src="/images/love-types/distance/independent.png" alt="自由マイペース型">
                                    距離感：<span id="distanceStyleType">自由マイペース型</span>
                                </div>
                                <div class="love-type-content" id="distanceStyleContent">
                                    束縛されることを嫌い、自分のペースを大切にします。相手にも自由を与え、お互いに成長できる関係を理想とします。
                                </div>
                            </div>
                            <div class="love-type-card">
                                <div class="love-type-title">
                                    <img src="/images/love-types/values/romantic.png" alt="ロマンチスト型">
                                    価値観：<span id="loveValuesType">ロマンチスト型</span>
                                </div>
                                <div class="love-type-content" id="loveValuesContent">
                                </div>
                            </div>
                            <div class="love-type-card">
                                <div class="love-type-title">
                                    <img src="/images/love-types/energy/intense.png" alt="燃え上がり型">
                                    エネルギー：<span id="loveEnergyType">燃え上がり型</span>
                                </div>
                                <div class="love-type-content" id="loveEnergyContent">
                                    あなたは恋愛において、一気に感情が燃え上がるタイプです。
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="lock-overlay-mini">
                        <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                    </div>
                </div>

                <!-- 月詠による恋愛タイプ総括 -->
                <div class="tsukuyomi-section">
                    <div class="tsukuyomi-character">
                        <img src="/images/tsukuyomi/5.png" alt="月詠">
                    </div>
                    <div class="tsukuyomi-bubble">
                        <div class="tsukuyomi-name">月詠</div>
                        <p>
                            いかがでしたでしょうか。あなた自身、自覚していた面も、初めて意識した面もあったと思います。これらすべてが、あなたという月の持つ多面的な輝きなのです。
                        </p>
                    </div>
                </div>

                <!-- 運命のカレンダーセクション -->
                    <!-- 月詠による直近3ヶ月導入 -->
                    <div class="tsukuyomi-section right">
                        <div class="tsukuyomi-character">
                            <img src="/images/tsukuyomi/7.png" alt="月詠">
                        </div>
                        <div class="tsukuyomi-bubble">
                            <div class="tsukuyomi-name">月詠</div>
                            <p>
                                ここまで、あなたの月相、裏の顔、3つの月の力、そして4つの軸から見たあなたの本質を見てきました。これらすべてを踏まえて、いよいよ<span style="color: #ffd700; font-weight: bold; font-size: 20px;">直近3ヶ月のあなたに訪れる運命</span>を読み解いていきます。全体運から始まり、恋愛運、人間関係運、仕事運、金運...月のリズムが教えてくれる、あなただけの3ヶ月の集中的なストーリーをお届けしますね。
                            </p>
                        </div>
                    </div>

                <!-- スターセパレーター -->
                <div class="star-separator"></div>

                <!-- 直近3ヶ月全体運 -->
                <div class="fortune-section destiny" style="padding-top: 0; margin-top: 30px; overflow: hidden;">
                    <!-- バナーを枠内の上部に配置 -->
                    <img src="/images/banner/7-unmei.png" alt="直近3ヶ月の運命" style="width: calc(100% + 16px); height: auto; display: block; margin: -8px -8px 20px -8px; border-radius: 8px 8px 0 0;">
                    <div class="section-header">
                        <h2 class="rhythm-heading" id="fortune-overall-title">未決定</h2>
                        <p id="fortune-overall-intro"></p>
                    </div>

                    <!-- 運勢グラフセクション（overall内に移動） -->
                    <div class="fortune-graph-section" style="margin: 30px 0;">
                        <div style="background: linear-gradient(135deg, rgba(20, 10, 50, 0.95), rgba(40, 20, 70, 0.95)); padding: 20px 15px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                            <h4 style="color: #ffd700; margin-bottom: 20px; text-align: center; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                                3ヶ月の運勢推移グラフ
                            </h4>
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div style="background: rgba(0, 0, 0, 0.2); border-radius: 10px; padding: 10px; position: relative;">
                                        <div style="height: 420px;">
                                            <canvas id="fortuneChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="fortune-content">
                        <!-- overall-1.pngバナーと直下のテキストを削除 -->
                        <!-- 1ヶ月目・2ヶ月目の展開と注意ポイントを削除 -->
                    </div>
                </div>

                <!-- 恋愛運セクション -->
                <!-- 月詠による恋愛運への移行 -->
                <div class="tsukuyomi-section">
                    <div class="tsukuyomi-character">
                        <img src="/images/tsukuyomi/7.png" alt="月詠">
                    </div>
                    <div class="tsukuyomi-bubble">
                        <div class="tsukuyomi-name">月詠</div>
                        <p>
                            全体運を踏まえて、次に気になるのは恋愛運ですね。直近3ヶ月、あなたの恋愛にはどんな展開が待っているのでしょうか。月の導きから、あなたの恋の行方を詳しく見ていきましょう。
                        </p>
                    </div>
                </div>

                <!-- 恋愛運バナー -->
                <div class="fortune-banner-wrapper">
                    <img src="/images/banner/8-rennai.png" alt="あなたの恋愛運" class="fortune-main-banner">

                    <!-- 恋愛運 -->
                    <div class="fortune-section love">
                        <div class="fortune-content">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="fortune-highlight">
                                        <p class="fortune-love-text" id="fortune-love-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>

                            <!-- 新規セクション：運命的な出会い -->
                            <img src="/images/banner/love-1.png" alt="あなたの心をときめかせる、運命的な出会いは訪れる？" class="section-banner">
                            <div class="content-locked-mini love-section-box">
                                <div class="text-blur">
                                    <div class="love-new-section hanging-text">
                                        <p id="fortune-love-destiny-meeting" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>

                            <!-- 新規セクション：恋の矢を向けている相手 -->
                            <img src="/images/banner/love-2.png" alt="今後3ヶ月、あなたに恋の矢を向けているお相手はこんな人" class="section-banner">
                            <div class="content-locked-mini love-section-box">
                                <div class="text-blur">
                                    <div class="love-new-section hanging-text">
                                        <p id="fortune-love-admirer-type" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>

                            <!-- 新規セクション：危険な異性のタイプ -->
                            <img src="/images/banner/love-3.png" alt="危険な恋の罠？この3ヶ月、あなたが出会うと危険な異性のタイプ" class="section-banner">
                            <div class="content-locked-mini love-section-box">
                                <div class="text-blur">
                                    <div class="love-new-section hanging-text">
                                        <p id="fortune-love-dangerous-type" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>

                            <!-- 恋愛の注意ポイントを削除 -->
                        </div>
                    </div>
                </div>

                <!-- 人間関係運セクション -->
                <!-- 月詠による人間関係運への移行 -->
                <div class="tsukuyomi-section right">
                    <div class="tsukuyomi-character">
                        <img src="/images/tsukuyomi/4.png" alt="月詠">
                    </div>
                    <div class="tsukuyomi-bubble">
                        <div class="tsukuyomi-name">月詠</div>
                        <p>
                            恋愛運はいかがでしたか？さて、恋愛だけでなく、すべての人間関係も見ていきましょう。直近3ヶ月、あなたの周りにはどんな人が集まってくるのでしょうか。
                        </p>
                    </div>
                </div>

                <!-- 人間関係運 -->
                <div class="fortune-banner-wrapper">
                    <img src="/images/banner/9-ningenn.png" alt="あなたの人間関係運" class="fortune-main-banner">

                    <div class="fortune-section relationship">
                        <div class="fortune-content">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="fortune-highlight">
                                        <p class="fortune-relationship-text" id="fortune-relationship-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>

                            <!-- 新規セクション：新しい人間関係 -->
                            <img src="/images/banner/relation-1.png" alt="今後3ヶ月であなたが築くことになる、新しい人間関係とは" class="section-banner">
                            <div class="content-locked-mini love-section-box">
                                <div class="text-blur">
                                    <div class="relationship-new-section hanging-text">
                                        <p id="fortune-relationship-new-connections" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>

                            <!-- 新規セクション：人間関係の転機 -->
                            <img src="/images/banner/relation-2.png" alt="人間関係の転機が訪れます。切るべき縁と繋ぐべき縁とは？" class="section-banner">
                            <div class="content-locked-mini love-section-box">
                                <div class="text-blur">
                                    <div class="relationship-new-section hanging-text">
                                        <p id="fortune-relationship-challenges" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>

                            <!-- 人間関係の注意ポイントを削除 -->
                        </div>
                    </div>
                </div>

                <!-- 仕事運セクション -->
                <!-- 月詠による仕事運への移行 -->
                <div class="tsukuyomi-section">
                    <div class="tsukuyomi-character">
                        <img src="/images/tsukuyomi/3.png" alt="月詠">
                    </div>
                    <div class="tsukuyomi-bubble">
                        <div class="tsukuyomi-name">月詠</div>
                        <p>
                            人間関係の流れを踏まえて、次は仕事運を見ていきましょう。直近3ヶ月、あなたの仕事やキャリアにはどんな展開が待っているのでしょうか。
                        </p>
                    </div>
                </div>

                <!-- 仕事運 -->
                <div class="fortune-banner-wrapper">
                    <img src="/images/banner/10-shigoto.png" alt="あなたの仕事運" class="fortune-main-banner">

                    <div class="fortune-section work">
                        <div class="fortune-content">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="fortune-highlight">
                                        <p class="fortune-work-text" id="fortune-work-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>

                            <!-- 新規セクション：仕事での躍進チャンス -->
                            <img src="/images/banner/work-1.png" alt="仕事での躍進チャンスは今にも手に届きそう" class="section-banner">
                            <div class="content-locked-mini love-section-box">
                                <div class="text-blur">
                                    <div class="work-new-section hanging-text">
                                        <p id="fortune-work-new-talent" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>

                            <!-- 新規セクション：避けるべき落とし穴 -->
                            <img src="/images/banner/work-2.png" alt="仕事で陥りがちな落とし穴" class="section-banner">
                            <div class="content-locked-mini love-section-box">
                                <div class="text-blur">
                                    <div class="work-new-section hanging-text">
                                        <p id="fortune-work-turning-point" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>

                            <!-- 仕事の注意ポイントを削除 -->
                        </div>
                    </div>
                </div>

                <!-- 金運セクション -->
                <!-- 月詠による金運への移行 -->
                <div class="tsukuyomi-section right">
                    <div class="tsukuyomi-character">
                        <img src="/images/tsukuyomi/6.png" alt="月詠">
                    </div>
                    <div class="tsukuyomi-bubble">
                        <div class="tsukuyomi-name">月詠</div>
                        <p>
                            最後に、誰もが気になる金運を見ていきましょう。直近3ヶ月、あなたの財運にはどんな流れが訪れるのでしょうか。
                        </p>
                    </div>
                </div>

                <!-- 金運 -->
                <div class="fortune-banner-wrapper">
                    <img src="/images/banner/11-kin.png" alt="あなたの金運" class="fortune-main-banner">

                    <div class="fortune-section money">
                        <div class="fortune-content">
                            <div class="content-locked-mini">
                                <div class="text-blur">
                                    <div class="fortune-highlight">
                                        <p class="fortune-money-text" id="fortune-money-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>

                            <!-- 新規セクション：ラッキーアクション -->
                            <img src="/images/banner/money-1.png" alt="あなたの金運を底上げする、とっておきのラッキーアクション" class="section-banner">
                            <div class="content-locked-mini love-section-box">
                                <div class="text-blur">
                                    <div class="money-new-section hanging-text">
                                        <div id="fortune-money-lucky">
                                            <p>
                                                新月の日に財布を新調し、満月の夜に財布を月光浴させると金運UP。月が欠けていく時期は無駄遣いを控え、毎月の新月と満月に財布を整理することが大切。
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>

                            <!-- 新規セクション：金銭トラブル回避 -->
                            <img src="/images/banner/money-2.png" alt="お金の貸し借りは慎重に。人間関係にヒビを入れる金銭問題" class="section-banner">
                            <div class="content-locked-mini love-section-box">
                                <div class="text-blur">
                                    <div class="money-new-section hanging-text">
                                        <p id="fortune-money-trouble" class="fortune-text"></p>
                                    </div>
                                </div>
                                <div class="lock-overlay-mini">
                                    <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 月詠による月齢カレンダーへの移行 -->
                <div class="tsukuyomi-section">
                    <div class="tsukuyomi-character">
                        <img src="/images/tsukuyomi/5.png" alt="月詠">
                    </div>
                    <div class="tsukuyomi-bubble">
                        <div class="tsukuyomi-name">月詠</div>
                        <p>
                            ここで特別なプレゼントがあります！恋愛運をさらに活かすために、あなただけの特別な月齢カレンダーをお伝えしますね。
                        </p>
                    </div>
                </div>

                <!-- 月齢カレンダー -->
                <div class="monthly-fortune">
                    <div id="moonCalendarSection">
                        <!-- カレンダーはJavaScriptで動的に生成 -->
                    </div>
                </div>

                <!-- 月詠による最終メッセージへの導入 -->
                <div class="tsukuyomi-section right">
                    <div class="tsukuyomi-character">
                        <img src="/images/tsukuyomi/2.png" alt="月詠">
                    </div>
                    <div class="tsukuyomi-bubble">
                        <div class="tsukuyomi-name">月詠</div>
                        <p>
                            ここまで長い診断でしたね。最後に、直近3ヶ月を幸せに過ごすための特別な鍵をお伝えします。
                        </p>
                    </div>
                </div>

                <!-- 最後のメッセージセクション -->
                <!-- 最終メッセージ -->
                <div class="final-message">
                    <!-- 「新月のあなたは」バナーを先に -->
                    <div style="margin-bottom: 30px;">
                        <img src="/images/banner/12-saigo.png" alt="月が教えてくれる5つの教え" style="max-width: 100%; height: auto; margin-bottom: 5px;">
                        <div class="content-locked-mini">
                            <div class="text-blur">
                                <p>
                                    新月のあなたは、常に新しいことへチャレンジする勇気を持っています。その勇気は素晴らしいものですが、時には立ち止まることも大切。月のリズムに合わせて、緩急をつけることで、より大きな成果を得られるでしょう。
                                </p>
                            </div>
                            <div class="lock-overlay-mini">
                                <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                            </div>
                        </div>
                    </div>

                    <!-- その後に「最も重要なメッセージ」と「5つの教え」 -->
                    <img src="/images/banner/last.png" alt="月が教えてくれる最も重要なメッセージ" style="width: 100%; height: auto; margin-bottom: 20px;">
                    <div class="content-locked-mini">
                        <div class="text-blur">
                            <!-- 動的に表示される月が教えてくれる最も重要なメッセージ -->
                            <div id="fortune-important-message" style="text-align: left; margin: 30px 0;">
                                <!-- ここに動的にメッセージが表示されます -->
                            </div>
                        </div>
                        <div class="lock-overlay-mini">
                            <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                        </div>
                    </div>
                </div>

                    <!-- 月詠の最終メッセージ -->
                    <div class="tsukuyomi-section">
                        <div class="tsukuyomi-character">
                            <img src="/images/tsukuyomi/9.png" alt="月詠">
                        </div>
                        <div class="tsukuyomi-bubble">
                            <div class="tsukuyomi-name">月詠</div>
                            <p>
                                長い診断でしたが、最後まで聞いてくださってありがとうございました。ここまで、あなたの月相、裏の顔、3つの月の力、4つの軸から見たあなたの本質、そして直近3ヶ月の運勢を見てきました。月の光は、あなたの内なる光を映し出す鏡。この診断を通して、あなたが本当の自分を見つけ、より輝かしい人生を歩むきっかけになれば幸いです。月のリズムと共に、素晴らしい日々をお過ごしくださいね。
                            </p>
                        </div>
                    </div>

                    <!-- おつきさまからの約束（CTA） -->
                    <div class="moon-promise-section" style="background: linear-gradient(135deg, rgba(118, 75, 162, 0.1), rgba(102, 126, 234, 0.1)); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 20px; padding: 40px 20px; margin: 40px auto; max-width: 600px; text-align: center;">
                        <h2 style="color: #ffd700; font-size: 24px; margin-bottom: 20px; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);">
                            🌙 おつきさまからの約束
                        </h2>

                        <p style="color: #fff; line-height: 1.8; margin-bottom: 25px;">
                            <span class="user-name-display">あなた</span>さん、<br>
                            今日ここで受け取ったおつきさまからのメッセージは、<br>
                            読んで終わりではありません。
                        </p>

                        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px; margin: 20px 0;">
                            <p style="color: #87ceeb; font-size: 16px; margin-bottom: 15px;">
                                おつきさまは、<span id="nextVisitDate" style="color: #ffd700; font-weight: bold;">2週間後</span>に<br>
                                もう一度、<span class="user-name-display">あなた</span>さんのもとを訪れます。
                            </p>

                            <p style="color: #ccc; font-size: 14px; line-height: 1.6;">
                                そのとき<br>
                                「今の行動が続けられているか」<br>
                                「心にどんな変化が芽生えているか」<br>
                                を一緒に確かめましょう。
                            </p>
                        </div>

                        <p style="color: #fff; margin: 20px 0; font-size: 15px;">
                            まずは小さな習慣を2週間続けるだけで、<br>
                            未来の景色は驚くほど変わります。
                        </p>

                        <div style="background: linear-gradient(135deg, #ffd700, #ffed4e); border-radius: 30px; padding: 3px; margin: 30px auto; max-width: 400px;">
                            <button onclick="saveToBookmark()" style="width: 100%; background: linear-gradient(135deg, #764ba2, #667eea); color: white; padding: 15px 30px; border: none; border-radius: 27px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                                📱 このページをブックマークする
                            </button>
                        </div>

                        <p style="color: #aaa; font-size: 13px; margin-top: 15px;">
                            「続けられているかな？」と感じたときは、<br>
                            またこのページを開いてみてください。
                        </p>

                        <p style="color: #ffd700; margin-top: 25px; font-size: 14px; font-style: italic;">
                            おつきさまはいつでも、<br>
                            <span class="user-name-display">あなた</span>さんのそばで成長を見守っています。
                        </p>
                    </div>

                    <!-- CTAセクション -->
                    <div class="cta-section">
                        <h3 class="cta-title">月詠とLINEで繋がる</h3>
                        <p class="cta-description">
                            毎日の月齢メッセージ、週間運勢グラフ、月相別開運アドバイスをお届けします。
                            今なら友だち追加で特別な月のメッセージをプレゼント！
                        </p>
                        <a href="https://lin.ee/egmCXoG" class="cta-button">🌙 LINE友だち追加する</a>
                    </div>
                </div>
        </div><!-- premium-content-wrapper終了 -->
    </div><!-- container終了 -->

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/otsukisama-data-loader.js?v=20250108002"></script>
    <script src="js/text-formatter.js?v=20250107001"></script>
    <script src="js/personality-type-mapper.js?v=20250107001"></script>
    <script src="js/three-powers-calculator.js?v=20250107002"></script>
    <script src="js/lp-otsukisama-moon.js?v=20250901001"></script>
    <script src="js/lp-otsukisama-api.js?v=20250901001"></script>
    <script src="js/lp-otsukisama-display.js?v=20250107001"></script>
    <script src="js/lp-otsukisama-display-line.js?v=20250901001"></script>
    <!-- カレンダー関連スクリプト - text-basedのみ使用 -->
    <script src="js/fortune-date-extractor.js?v=20250111003"></script>
    <script src="js/lp-otsukisama-calendar-text-based.js?v=20250111003"></script>
    <script src="js/lp-otsukisama-graph.js?v=20250901001"></script>
    <script src="js/fortune-date-calculator.js?v=20250109001"></script>
    <script src="js/fortune-display.js?v=20250109001"></script>

    <!-- lp-otsukisama-main.jsは統合版では使用しない（重複を避けるため） -->

    <script>
        // グローバル変数
        let currentPatternId = null;
        let userName = '〇〇'; // デフォルトユーザー名
        window.moonPhaseData = null;
        window.hiddenPhaseData = null;
        window.uiTexts = null;

        // データの読み込み
        async function loadDataFiles() {
            try {
                const [moonPhases, hiddenPhases, texts] = await Promise.all([
                    fetch('/data/moon-phase-descriptions.json').then(r => r.json()),
                    fetch('/data/hidden-phase-descriptions.json').then(r => r.json()),
                    fetch('/data/ui-texts.json').then(r => r.json())
                ]);

                window.moonPhaseData = moonPhases;
                window.hiddenPhaseData = hiddenPhases;
                window.uiTexts = texts;

                // 3つの力計算機を初期化
                if (window.ThreePowersCalculator) {
                    await window.ThreePowersCalculator.load();
                }

                console.log('Data files loaded successfully');
                return true;
            } catch (error) {
                console.error('Failed to load data files:', error);
                return false;
            }
        }

        // スクロール進捗バーの更新
        function updateScrollProgress() {
            const scrollProgress = document.getElementById('scrollProgress');
            if (scrollProgress) {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                const scrollPercent = (scrollTop / scrollHeight) * 100;
                scrollProgress.style.width = scrollPercent + '%';
            }
        }

        // 表示モードを設定（APIレスポンスに基づいて動的に決定）
        function setDisplayMode(isPaid) {
            const pageBody = document.getElementById('pageBody');
            const loadingText = document.querySelector('.loading-text');

            if (isPaid) {
                // 完全版モード
                document.body.className = 'complete-mode';
                if (pageBody) pageBody.className = 'complete-mode';
                if (loadingText) {
                    loadingText.textContent = '診断結果を準備しています...';
                }
                // ページタイトルも更新
                document.title = 'おつきさま診断 - 月が導くあなたの運命';
                return 'complete';
            } else {
                // プレビューモード
                document.body.className = 'preview-mode';
                if (pageBody) pageBody.className = 'preview-mode';
                if (loadingText) {
                    loadingText.textContent = '診断結果を読み込んでいます...';
                }
                // ページタイトルも更新
                document.title = '診断結果プレビュー - おつきさま診断';
                return 'preview';
            }
        }

        // プレビュー・完全版統合の初期化関数
        async function initUnified() {
            const urlParams = new URLSearchParams(window.location.search);
            const diagnosisId = urlParams.get('id');

            // ローディングは既に表示されているので、進捗バーアニメーションのみ開始
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingProgress = document.getElementById('loadingProgress');

            // 進捗バーアニメーション
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress > 90) progress = 90; // 90%で一旦止める
                if (loadingProgress) {
                    loadingProgress.style.width = progress + '%';
                }
            }, 300);

            // データ読み込み完了時にクリア
            window.loadingProgressInterval = progressInterval;

            // 診断データを読み込み
            if (diagnosisId) {
                try {
                    console.log('診断データを取得中:', diagnosisId);
                    const userId = urlParams.get('userId');
                    const response = await fetch(`/api/profile-form-v2?action=get-diagnosis&id=${diagnosisId}&userId=${userId || ''}`);
                    const data = await response.json();
                    console.log('取得したデータ:', data);

                    if (data.success && data.diagnosis) {
                        // 診断日をグローバル変数に設定（データベースから取得したcreated_atを使用）
                        if (data.diagnosis.created_at) {
                            // グローバル変数に設定（lp-otsukisama-display.jsで使用）
                            window.globalDiagnosisDate = data.diagnosis.created_at;
                            console.log('診断日を設定:', data.diagnosis.created_at);

                            // URLパラメータにも追加（フォールバック用）
                            if (!urlParams.has('diagnosisDate')) {
                                urlParams.set('diagnosisDate', data.diagnosis.created_at);
                                const newUrl = window.location.pathname + '?' + urlParams.toString();
                                window.history.replaceState({}, '', newUrl);
                            }
                        }

                        // テストモードの確認（test=trueパラメータがある場合は権限をバイパス）
                        const isTestMode = urlParams.get('test') === 'true';

                        // アクセスレベルに基づいてモードを設定（テストモードの場合は常にfull）
                        const isPaid = isTestMode ? true : (data.accessLevel === 'full');
                        const mode = setDisplayMode(isPaid);
                        window.currentMode = mode;  // グローバルに保存

                        // テストモードの場合は警告表示
                        if (isTestMode) {
                            console.warn('⚠️ テストモード: 権限チェックをバイパスして完全版を表示しています');
                        }
                        window.currentUserId = userId;  // ユーザーIDも保存
                        // 名前を表示
                        const resultName = document.getElementById('resultName');
                        if (resultName) {
                            resultName.textContent = data.diagnosis.user_name || 'あなた';
                        }

                        // ユーザー名を定義（ローカル変数として）
                        const userName = data.diagnosis.user_name || '〇〇';

                        // パターンIDをグローバル変数に設定
                        currentPatternId = data.diagnosis.moon_pattern_id || data.diagnosis.pattern_id;

                        // 月相コンテンツを更新
                        if (typeof updateMoonPhaseContent === 'function') {
                            updateMoonPhaseContent(currentPatternId);
                        }

                        // 月相を計算して表示
                        const moonPhaseIndex = Math.floor(currentPatternId / 8);
                        const hiddenPhaseIndex = currentPatternId % 8;
                        const moonPhaseNames = ['新月', '三日月', '上弦の月', '十三夜', '満月', '十六夜', '下弦の月', '暁'];
                        const moonPhase = moonPhaseNames[moonPhaseIndex];
                        const hiddenMoonPhase = moonPhaseNames[hiddenPhaseIndex];

                        // 月相カードを動的に生成
                        updateMoonPhaseCard(currentPatternId, moonPhaseIndex, moonPhase);

                        // 裏月相カードを動的に生成（ユーザー名を渡す）
                        updateHiddenPhaseCard(currentPatternId, hiddenPhaseIndex, hiddenMoonPhase, userName);

                        // 3つの力を更新
                        const birthDate = data.diagnosis.birth_date || localStorage.getItem('birthDate');
                        if (birthDate) {
                            updateThreePowers(birthDate, moonPhase, userName);
                        }

                        // 4つの軸データを設定（データベースから直接使用）
                        const loveProfile = {
                            emotionalExpression: data.diagnosis.emotional_expression,
                            distanceStyle: data.diagnosis.distance_style,
                            loveValues: data.diagnosis.love_values,
                            loveEnergy: data.diagnosis.love_energy
                        };
                        console.log('=== 4つの軸データ確認 ===');
                        console.log('Database values:', loveProfile);
                        console.log('API response:', data.diagnosis);
                        console.log('Access level:', data.accessLevel);
                        console.log('Cache version: 20250108001');


                        // 6つの要素を更新
                        if (typeof updateSixElements === 'function') {
                            // 常に全データを渡す（アクセス制限を一旦無効化）
                            updateSixElements(currentPatternId, moonPhase, hiddenMoonPhase, loveProfile);
                        }

                        // 4つの軸データを表示（常に表示）
                        if (typeof updatePersonalityDisplay === 'function') {
                            console.log('Calling updatePersonalityDisplay with:', loveProfile);
                            await updatePersonalityDisplay(loveProfile);
                            console.log('updatePersonalityDisplay completed');
                        } else {
                            console.error('updatePersonalityDisplay is not defined');
                        }

                        // エネルギーコンテンツを更新（常に表示）
                        if (typeof updateLoveEnergyContent === 'function' && loveProfile.loveEnergy) {
                            await updateLoveEnergyContent(loveProfile.loveEnergy);
                        }

                        // 新しい運勢表示システムを使用
                        const fortuneDisplay = new FortuneDisplay();
                        await fortuneDisplay.loadFortuneData();
                        const graphType = await fortuneDisplay.displayAllFortunes(currentPatternId, userName);
                        console.log('Fortune display completed with graph type:', graphType);

                        // 旧システムとの互換性のため、パターンデータも更新
                        if (window.OtsukisamaDataLoader && window.OtsukisamaDataLoader.isLoaded()) {
                            const pattern = window.OtsukisamaDataLoader.getPatternFortune(currentPatternId);
                            console.log('Pattern data for legacy system:', pattern);
                            if (pattern && typeof updateDynamicContentFromPattern === 'function') {
                                await updateDynamicContentFromPattern(pattern);
                            }
                        } else {
                            // データローダーの読み込みを待ってから再試行
                            window.addEventListener('otsukisama-data-loaded', async () => {
                                const pattern = window.OtsukisamaDataLoader.getPatternFortune(currentPatternId);
                                console.log('Pattern data for legacy system (after wait):', pattern);
                                if (pattern && typeof updateDynamicContentFromPattern === 'function') {
                                    await updateDynamicContentFromPattern(pattern);
                                }
                            }, { once: true });
                        }

                        // グラフを初期化（常に表示） - 少し遅延を入れて確実に実行
                        setTimeout(async () => {
                            if (typeof updateFortuneGraph === 'function') {
                                console.log('Initializing fortune graph for pattern:', currentPatternId);
                                await updateFortuneGraph(currentPatternId);
                            } else {
                                console.error('updateFortuneGraph function not found');
                            }
                        }, 100);

                        // カレンダーを初期化（統合版を使用） - 運勢テキストが表示された後に実行
                        setTimeout(async () => {
                            // 診断テキストデータを取得（カレンダー用）
                            const fortuneTextData = {
                                overall: { text: document.getElementById('fortune-overall-text')?.textContent || document.getElementById('fortune-overall-text')?.innerText || '' },
                                love: { text: document.getElementById('fortune-love-text')?.textContent || document.getElementById('fortune-love-text')?.innerText || '' },
                                career: { text: document.getElementById('fortune-career-text')?.textContent || document.getElementById('fortune-career-text')?.innerText || '' },
                                relationship: { text: document.getElementById('fortune-relationship-text')?.textContent || document.getElementById('fortune-relationship-text')?.innerText || '' },
                                money: { text: document.getElementById('fortune-money-text')?.textContent || document.getElementById('fortune-money-text')?.innerText || '' }
                            };
                            
                            console.log('[Main] Fortune text data for calendar:', fortuneTextData);

                            if (typeof generateTextBasedCalendar === 'function') {
                                console.log('Initializing text-based calendar for pattern:', currentPatternId);
                                await generateTextBasedCalendar(currentPatternId, fortuneTextData);
                            } else if (typeof generateIntegratedCalendar === 'function') {
                                console.log('Falling back to integrated calendar for pattern:', currentPatternId);
                                await generateIntegratedCalendar(currentPatternId, fortuneData);
                            } else if (typeof generatePersonalizedCalendar === 'function') {
                                console.log('Falling back to original calendar for pattern:', currentPatternId);
                                await generatePersonalizedCalendar(currentPatternId);
                            } else {
                                console.error('Calendar generation function not found');
                            }
                        }, 500); // 運勢テキストが確実に表示された後に実行

                        console.log('データ表示完了');
                    } else {
                        console.error('診断データが取得できませんでした:', data);
                    }
                } catch (error) {
                    console.error('診断データの読み込みエラー:', error);
                } finally {
                    // ローディングを非表示（進捗バーを100%にしてから）
                    if (loadingOverlay) {
                        // 進捗バーを100%に
                        if (loadingProgress) {
                            loadingProgress.style.width = '100%';
                        }
                        // インターバルをクリア
                        if (window.loadingProgressInterval) {
                            clearInterval(window.loadingProgressInterval);
                        }
                        setTimeout(() => {
                            loadingOverlay.style.display = 'none';
                            document.body.classList.remove('loading-active');
                        }, 500);
                    }
                }
            } else {
                // 診断IDがない場合もローディングを非表示
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                    document.body.classList.remove('loading-active');
                    if (window.loadingProgressInterval) {
                        clearInterval(window.loadingProgressInterval);
                    }
                }
            }

            // プレビューモードの場合、購入ボタンの設定
            if (window.currentMode !== 'complete') {
                const purchaseButton = document.getElementById('purchaseButton');
                if (purchaseButton) {
                    purchaseButton.addEventListener('click', async () => {
                        // 決済選択画面へリダイレクト
                        const diagnosisId = urlParams.get('id');
                        const userId = urlParams.get('userId');
                        window.location.href = `/payment-select.html?id=${diagnosisId}&userId=${userId || ''}`;
                    });
                }

            }
        }

        // 購入処理を実行する関数
        // ブックマーク保存機能
        function saveToBookmark() {
            const pageTitle = 'おつきさま診断 - あなたの運命の3ヶ月';
            const pageUrl = window.location.href;

            // モバイルデバイスかチェック
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            if (navigator.share && isMobile) {
                // Web Share APIが使える場合（モバイル）
                navigator.share({
                    title: pageTitle,
                    text: 'おつきさまからのメッセージを定期的に確認しよう',
                    url: pageUrl
                }).then(() => {
                    alert('ブックマークに追加してください！');
                }).catch((error) => {
                    console.log('共有エラー:', error);
                });
            } else {
                // デスクトップの場合
                alert('このページをブックマークに追加してください。\n\nWindows: Ctrl + D\nMac: Command + D\n\nまたは、ブラウザのメニューから「ブックマークに追加」を選択してください。');
            }

            // 2週間後の日付を計算して表示
            const twoWeeksLater = new Date();
            twoWeeksLater.setDate(twoWeeksLater.getDate() + 14);
            const dateStr = `${twoWeeksLater.getMonth() + 1}月${twoWeeksLater.getDate()}日`;

            const nextVisitElement = document.getElementById('nextVisitDate');
            if (nextVisitElement) {
                nextVisitElement.textContent = `${dateStr}（2週間後）`;
            }
        }

        // 月相カードを動的に更新
        async function updateMoonPhaseCard(patternId, moonPhaseIndex, moonPhase) {
            const moonPhaseCard = document.querySelector('.moon-phase-card.new-moon');
            if (!moonPhaseCard) return;

            try {
                // 月相データを取得
                const response = await fetch('/data/moon-phase-descriptions.json?v=' + Date.now());
                const moonPhaseData = await response.json();
                const desc = moonPhaseData[moonPhase];

                if (desc) {
                    // カード全体のHTMLを更新
                    moonPhaseCard.innerHTML = `
                        <div class="moon-phase-label">月相</div>
                        <div class="moon-phase-header">
                            <img src="/images/moon/omote-${moonPhaseIndex}.png" alt="${moonPhase}" class="moon-phase-visual moon-phase-image">
                            <div class="moon-phase-info">
                                <h2>${moonPhase}</h2>
                                <p class="moon-phase-subtitle">${desc.title || ''}</p>
                            </div>
                        </div>
                        <div class="moon-phase-description" id="moon-phase-description">
                            ${desc.description || ''}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to update moon phase card:', error);
            }
        }

        // 裏月相カードを動的に更新
        async function updateHiddenPhaseCard(patternId, hiddenPhaseIndex, hiddenMoonPhase, userName = null) {
            const hiddenPhaseCard = document.getElementById('hidden-phase-card');
            if (!hiddenPhaseCard) return;

            try {
                // 裏月相データを取得
                const response = await fetch('/data/hidden-phase-descriptions.json?v=' + Date.now());
                const hiddenPhaseData = await response.json();
                const desc = hiddenPhaseData[hiddenMoonPhase];

                if (desc) {
                    // ユーザー名を取得（パラメータから、またはlocalStorageから）
                    const displayName = userName || localStorage.getItem('userName') || '〇〇';

                    // ユーザー名置換を適用（HTMLタグはそのまま保持）
                    const processText = (text) => {
                        if (!text) return '';
                        return text.replace(/〇〇/g, displayName);
                    };

                    const processedMainText1 = processText(desc.mainText1);
                    const processedMainText2 = processText(desc.mainText2);
                    const processedDescription = processText(desc.description);

                    // HTMLを生成
                    let html = `
                        <div class="moon-phase-label">裏月相</div>
                        <div class="moon-phase-header">
                            <img src="/images/moon/ura-${hiddenPhaseIndex}.png" alt="${hiddenMoonPhase}" class="moon-phase-visual moon-phase-image">
                            <div class="moon-phase-info">
                                <h2>${hiddenMoonPhase}</h2>
                                ${desc.title ? `<p class="moon-phase-subtitle">${desc.title}</p>` : ''}
                            </div>
                        </div>
                        <div class="content-locked-mini">
                            <div class="text-blur">
                                <div class="moon-phase-description" id="hidden-phase-description">
                                    ${processedMainText1 ? `<p>${processedMainText1}</p>` : ''}
                                    ${desc.bulletPoints ? `
                                        <div class="hidden-phase-moment">
                                            <p class="moment-title"><strong>こんな瞬間、ありませんか？</strong></p>
                                            <ul>
                                                ${desc.bulletPoints.map(point => `<li>${processText(point)}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${processedMainText2 ? `<p>${processedMainText2}</p>` : ''}
                                    ${!processedMainText1 && processedDescription ? `<p>${processedDescription}</p>` : ''}
                                </div>
                            </div>
                            <div class="lock-overlay-mini">
                                <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                            </div>
                        </div>
                    `;

                    hiddenPhaseCard.innerHTML = html;
                } else {
                    // フォールバック：デフォルトの内容を表示
                    hiddenPhaseCard.innerHTML = `
                        <div class="moon-phase-header">
                            <img src="/images/moon/ura-${hiddenPhaseIndex}.png" alt="${hiddenMoonPhase}" class="moon-phase-visual moon-phase-image">
                            <div class="moon-phase-info">
                                <h2>${hiddenMoonPhase}</h2>
                                <p class="moon-phase-subtitle">内なる繊細さと慎重さを秘めた策士</p>
                            </div>
                        </div>
                        <div class="content-locked-mini">
                            <div class="text-blur">
                                <div class="moon-phase-description" id="hidden-phase-description">
                                    表向きは勢いよく突き進むあなたですが、実は内面では細やかな配慮ができる繊細な人。
                                </div>
                            </div>
                            <div class="lock-overlay-mini">
                                <button class="purchase-button-mini" onclick="scrollToPayment()">🔒 購入する</button>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('裏月相カード更新エラー:', error);
            }
        }

        // 3つの力を更新する関数
        async function updateThreePowers(birthdate, moonPhase, userName = null) {
            const container = document.getElementById('threePowersContainer');
            if (!container) {
                console.log('3つの力のコンテナが見つかりません');
                return;
            }

            // ThreePowersCalculatorが読み込まれているか確認
            if (!window.ThreePowersCalculator) {
                console.error('ThreePowersCalculator が読み込まれていません');
                return;
            }

            try {
                // 3つの力を計算
                const powers = await window.ThreePowersCalculator.calculate(birthdate, moonPhase);
                if (!powers) {
                    console.error('3つの力の計算に失敗しました');
                    return;
                }

                const displayName = userName || localStorage.getItem('userName') || '〇〇';

                // 既存の要素をクリア
                container.innerHTML = '';

                // 行動の力
                if (powers.action) {
                    const actionItem = document.createElement('div');
                    actionItem.className = 'energy-item';

                    const actionTitle = document.createElement('div');
                    actionTitle.className = 'energy-title';
                    actionTitle.textContent = powers.action.title;

                    const actionDesc = document.createElement('div');
                    actionDesc.className = 'energy-description';
                    // ユーザー名置換と改行処理
                    let processedDesc = powers.action.desc.replace(/〇〇/g, displayName);
                    processedDesc = processedDesc.replace(/\n/g, '<br>');
                    actionDesc.innerHTML = processedDesc;

                    actionItem.appendChild(actionTitle);
                    actionItem.appendChild(actionDesc);
                    container.appendChild(actionItem);
                }

                // 感情の力
                if (powers.emotion) {
                    const emotionItem = document.createElement('div');
                    emotionItem.className = 'energy-item';

                    const emotionTitle = document.createElement('div');
                    emotionTitle.className = 'energy-title';
                    emotionTitle.textContent = powers.emotion.title;

                    const emotionDesc = document.createElement('div');
                    emotionDesc.className = 'energy-description';
                    // ユーザー名置換と改行処理
                    let processedDesc = powers.emotion.desc.replace(/〇〇/g, displayName);
                    processedDesc = processedDesc.replace(/\n/g, '<br>');
                    emotionDesc.innerHTML = processedDesc;

                    emotionItem.appendChild(emotionTitle);
                    emotionItem.appendChild(emotionDesc);
                    container.appendChild(emotionItem);
                }

                // 思考の力
                if (powers.thinking) {
                    const thinkingItem = document.createElement('div');
                    thinkingItem.className = 'energy-item';

                    const thinkingTitle = document.createElement('div');
                    thinkingTitle.className = 'energy-title';
                    thinkingTitle.textContent = powers.thinking.title;

                    const thinkingDesc = document.createElement('div');
                    thinkingDesc.className = 'energy-description';
                    // ユーザー名置換と改行処理
                    let processedDesc = powers.thinking.desc.replace(/〇〇/g, displayName);
                    processedDesc = processedDesc.replace(/\n/g, '<br>');
                    thinkingDesc.innerHTML = processedDesc;

                    thinkingItem.appendChild(thinkingTitle);
                    thinkingItem.appendChild(thinkingDesc);
                    container.appendChild(thinkingItem);
                }

                console.log('3つの力を更新しました');

            } catch (error) {
                console.error('3つの力の更新エラー:', error);
            }
        }

        // ユーザー名表示の更新
        function updateUserNameDisplays() {
            const userName = window.currentUserName || 'あなた';
            const displayName = userName === 'あなた' ? 'あなた' : userName + 'さん';

            document.querySelectorAll('.user-name-display').forEach(elem => {
                elem.textContent = userName;
            });
        }

        async function scrollToPayment() {
            const urlParams = new URLSearchParams(window.location.search);
            const diagnosisId = urlParams.get('id');
            const userId = window.currentUserId || 'anonymous';

            // PayPay決済画面へリダイレクト
            window.location.href = `/payment-select.html?id=${diagnosisId}&userId=${userId}`;
        }

        // DOMロード後に初期化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM Content Loaded - Initializing unified page...');

            // データファイルを読み込み
            await loadDataFiles();

            // データローダーの読み込みを待つ
            if (!window.OtsukisamaDataLoader || !window.OtsukisamaDataLoader.isLoaded()) {
                console.log('データローダーの読み込みを待機中...');
                await new Promise(resolve => {
                    window.addEventListener('otsukisama-data-loaded', resolve, { once: true });
                });
                console.log('データローダー読み込み完了');
            }

            // URLパラメータから診断IDとユーザーIDを取得
            const urlParams = new URLSearchParams(window.location.search);
            const diagnosisId = urlParams.get('id');
            const userId = urlParams.get('userId');

            // 診断データを取得して表示
            if (diagnosisId) {
                try {
                    const response = await fetch(`/api/profile-form-v2?action=get-diagnosis&id=${diagnosisId}`);
                    const data = await response.json();

                    if (data.success && data.diagnosis) {
                        console.log('診断データ取得成功:', data.diagnosis);

                        // 診断日をグローバル変数に設定（データベースから取得したcreated_atを使用）
                        if (data.diagnosis.created_at) {
                            // グローバル変数に設定
                            window.globalDiagnosisDate = data.diagnosis.created_at;
                            console.log('診断日を設定:', data.diagnosis.created_at);

                            // URLパラメータにも追加（フォールバック用）
                            const urlParams = new URLSearchParams(window.location.search);
                            if (!urlParams.has('diagnosisDate')) {
                                urlParams.set('diagnosisDate', data.diagnosis.created_at);
                                const newUrl = window.location.pathname + '?' + urlParams.toString();
                                window.history.replaceState({}, '', newUrl);
                            }
                        }

                        // ユーザー名をグローバル変数に設定
                        window.currentUserName = data.diagnosis.user_name || 'あなた';

                        // ユーザー名表示を更新
                        updateUserNameDisplays();

                        // 診断データから誕生日と3つの力のキーを保存
                        if (data.diagnosis.birth_date) {
                            window.currentUserBirthdate = data.diagnosis.birth_date;
                        }
                        if (data.diagnosis.three_powers_keys) {
                            window.currentThreePowersKeys = data.diagnosis.three_powers_keys;
                        }

                        // 月相パターンIDを設定
                        if (typeof currentPatternId !== 'undefined') {
                            currentPatternId = data.diagnosis.moon_pattern_id || data.diagnosis.pattern_id;

                            // 月相コンテンツを更新
                            if (typeof updateMoonPhaseContent === 'function') {
                                updateMoonPhaseContent(currentPatternId);
                            }

                            // パターンIDから月相を計算
                            const moonPhaseIndex = Math.floor(currentPatternId / 8);
                            const hiddenPhaseIndex = currentPatternId % 8;
                            const moonPhaseNames = ['新月', '三日月', '上弦の月', '十三夜', '満月', '十六夜', '下弦の月', '暁'];
                            const moonPhase = moonPhaseNames[moonPhaseIndex];
                            const hiddenMoonPhase = moonPhaseNames[hiddenPhaseIndex];

                            // 月相カードを動的に生成
                            updateMoonPhaseCard(currentPatternId, moonPhaseIndex, moonPhase);

                            // 裏月相カードを動的に生成（ユーザー名を渡す）
                            const userName = data.diagnosis.user_name || localStorage.getItem('userName');
                            updateHiddenPhaseCard(currentPatternId, hiddenPhaseIndex, hiddenMoonPhase, userName);

                            // 3つの力の更新はupdateMoonPhaseContent内で行われるためここでは不要
                            // updateMoonPhaseContentが呼ばれない場合のみ更新
                            if (!window.currentThreePowersKeys) {
                                const birthDate = data.diagnosis.birth_date || localStorage.getItem('birthDate');
                                if (birthDate) {
                                    updateThreePowers(birthDate, moonPhase, userName);
                                }
                            }

                            // 6つの要素を更新（4つの軸データを含む）
                            if (typeof updateSixElements === 'function') {
                                const profile = {
                                    emotionalExpression: data.diagnosis.emotional_expression,
                                    distanceStyle: data.diagnosis.distance_style,
                                    loveValues: data.diagnosis.love_values,
                                    loveEnergy: data.diagnosis.love_energy,
                                    userName: data.diagnosis.user_name
                                };
                                updateSixElements(currentPatternId, moonPhase, hiddenMoonPhase, profile);
                            }

                            // グラフデータも更新
                            if (typeof updateFortuneGraph === 'function') {
                                updateFortuneGraph(currentPatternId);
                            }

                            // 4つの軸の結果を更新
                            if (typeof updatePersonalityDisplay === 'function') {
                                const profile = {
                                    emotionalExpression: data.diagnosis.emotional_expression,
                                    distanceStyle: data.diagnosis.distance_style,
                                    loveValues: data.diagnosis.love_values,
                                    loveEnergy: data.diagnosis.love_energy,
                                    userName: data.diagnosis.user_name
                                };
                                updatePersonalityDisplay(profile);
                            }

                            // 組み合わせ診断文を生成して表示
                            if (typeof displayCombinedPersonality === 'function') {
                                const profile = {
                                    emotionalExpression: data.diagnosis.emotional_expression,
                                    distanceStyle: data.diagnosis.distance_style,
                                    loveValues: data.diagnosis.love_values,
                                    loveEnergy: data.diagnosis.love_energy,
                                    userName: data.diagnosis.user_name
                                };
                                displayCombinedPersonality(profile);
                            }
                        }
                    }
                } catch (error) {
                    console.error('診断データ取得エラー:', error);
                }
            }

            // ユーザープロファイルも読み込む（互換性のため）
            // userIdがある場合、またはpatternパラメータがある場合
            const patternParam = urlParams.get('pattern');
            if ((userId || patternParam !== null) && typeof loadUserProfile === 'function') {
                await loadUserProfile();
            }

            // 星空背景を生成
            const starsContainer = document.getElementById('starsContainer');
            if (starsContainer && !starsContainer.children.length) {
                for (let i = 0; i < 100; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    star.style.animationDelay = Math.random() * 3 + 's';
                    star.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    starsContainer.appendChild(star);
                }
            }

            // スクロール進捗バーの設定
            window.addEventListener('scroll', updateScrollProgress);

            // 統合初期化を実行
            await initUnified();
        });
    </script>

    <!-- フッターセクション -->
    <footer style="
        background: linear-gradient(135deg, #0a001a 0%, #1a0033 100%);
        padding: 60px 20px 30px;
        margin-top: 100px;
        border-top: 1px solid rgba(255, 215, 0, 0.2);
    ">
        <div style="
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        ">
            <!-- 免責事項 -->
            <div style="
                margin-bottom: 40px;
                padding: 30px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 15px;
                border: 1px solid rgba(255, 215, 0, 0.1);
            ">
                <h3 style="
                    color: #ffd700;
                    font-size: 18px;
                    margin-bottom: 15px;
                    font-weight: bold;
                ">ご利用にあたっての注意事項</h3>
                <p style="
                    color: rgba(255, 255, 255, 0.8);
                    font-size: 12px;
                    line-height: 1.8;
                    text-align: left;
                ">
                    ※ 本サービスは占い・エンターテインメントを目的としたものであり、科学的根拠に基づく医学的・心理学的な診断ではありません。<br>
                    ※ 診断結果は参考程度にお楽しみください。<br>
                    ※ デジタルコンテンツの性質上、購入後の返品・交換はお受けしておりません。<br>
                    ※ 診断結果に基づく行動により生じた損害について、当社は一切責任を負いません。
                </p>
            </div>

            <!-- リンク集 -->
            <div style="
                margin-bottom: 30px;
                display: flex;
                justify-content: center;
                gap: 30px;
                flex-wrap: wrap;
            ">
                <a href="/tokusho.html" style="
                    color: #ffd700;
                    text-decoration: none;
                    font-size: 14px;
                    transition: opacity 0.3s;
                " onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
                    特定商取引法に基づく表記
                </a>
                <a href="/privacy-policy.html" style="
                    color: #ffd700;
                    text-decoration: none;
                    font-size: 14px;
                    transition: opacity 0.3s;
                " onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
                    プライバシーポリシー
                </a>
                <a href="/contact.html" style="
                    color: #ffd700;
                    text-decoration: none;
                    font-size: 14px;
                    transition: opacity 0.3s;
                " onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
                    お問い合わせ
                </a>
            </div>

            <!-- コピーライト -->
            <div style="
                padding-top: 20px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                color: rgba(255, 255, 255, 0.5);
                font-size: 12px;
            ">
                <p>© 2025 おつきさま診断 | MiNTs株式会社</p>
                <p style="margin-top: 5px;">All rights reserved.</p>
            </div>
        </div>
    </footer>
    <!-- スクロールアニメーション用JavaScript -->
    <script>
    (function() {
        // アニメーション対象の要素を取得
        const animateElements = [
            '.moon-phase-card',
            '#hidden-phase-card',
            '.fortune-section',
            '.monthly-fortune',
            '.tsukuyomi-section',
            '.three-powers',
            '.six-elements',
            '#important-message-section',
            '#moonCalendarSection',
            '#fortune-graph',
            '.banner-image',
            '.feelings-section ul li',
            '.evidence-section ul li',
            '.important-actions-list li'
        ];

        // Intersection Observer の設定
        const observerOptions = {
            root: null,
            rootMargin: '100px 0px', // 100px手前からアニメーション開始
            threshold: 0.01 // 要素の1%が見えたらアニメーション開始
        };

        // アニメーションクラスを追加 - 全てフェードインに統一
        const animationClasses = {
            '.moon-phase-card': 'animate-fade-in',
            '#hidden-phase-card': 'animate-fade-in',
            '.fortune-section': 'animate-fade-in',
            '.fortune-section.love': 'animate-fade-in', // 恋愛運専用
            '.monthly-fortune': 'animate-fade-in',
            '.tsukuyomi-section': 'animate-fade-in',
            '.three-powers': 'animate-fade-in',
            '.six-elements': 'animate-fade-in',
            '#important-message-section': 'animate-fade-in',
            '#moonCalendarSection': 'animate-fade-in',
            '#fortune-graph': 'animate-fade-in',
            '.banner-image': 'animate-fade-in',
            '.feelings-section ul li': 'animate-fade-in',
            '.evidence-section ul li': 'animate-fade-in',
            '.important-actions-list li': 'animate-fade-in'
        };

        // Observer コールバック
        const observerCallback = (entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const element = entry.target;
                    const selector = Object.keys(animationClasses).find(key =>
                        element.matches(key)
                    );

                    if (selector) {
                        element.classList.add(animationClasses[selector]);
                        observer.unobserve(element); // 一度アニメーションしたら監視を解除
                    }
                }
            });
        };

        // Observer を作成
        const observer = new IntersectionObserver(observerCallback, observerOptions);

        // ページ読み込み後に要素を監視開始
        document.addEventListener('DOMContentLoaded', () => {
            animateElements.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(element => {
                    // 初期状態で非表示
                    element.style.opacity = '0';
                    observer.observe(element);
                });
            });
        });
    })();
    </script>
</body>
</html>
