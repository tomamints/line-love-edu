<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>新規セクション動作テスト</title>
    <style>
        body { 
            padding: 20px; 
            font-family: sans-serif; 
            background: #1a1a2e;
            color: #fff;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ffd700; 
            background: rgba(255,255,255,0.05);
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        pre { 
            background: #000; 
            padding: 10px; 
            overflow-x: auto; 
            border: 1px solid #333;
        }
        h2 { color: #ffd700; }
        h3 { color: #ffeb3b; }
        button {
            background: #ffd700;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #ffeb3b;
        }
    </style>
</head>
<body>
    <h1>おつきさま診断 - 新規セクション動作テスト</h1>
    
    <div class="test-section">
        <h2>テストコントロール</h2>
        <button onclick="testPattern(0)">パターン0をテスト（新月×新月）</button>
        <button onclick="testPattern(13)">パターン13をテスト（三日月×十六夜）</button>
        <button onclick="testPattern(32)">パターン32をテスト（満月×新月）</button>
        <button onclick="testRandomPattern()">ランダムパターンをテスト</button>
    </div>
    
    <div class="test-section">
        <h2>データ読み込み状態</h2>
        <div id="data-status">
            <p>データ読み込み中...</p>
        </div>
    </div>
    
    <div class="test-section">
        <h2>新規セクション表示テスト</h2>
        
        <!-- 恋愛運の新規セクション -->
        <img src="/images/banner/love-1.png" alt="運命的な出会い" class="section-banner">
        <div class="love-new-section hanging-text">
            <p id="fortune-love-destiny-meeting"></p>
        </div>
        
        <img src="/images/banner/love-2.png" alt="恋の矢を向けている相手" class="section-banner">
        <div class="love-new-section hanging-text">
            <p id="fortune-love-admirer-type"></p>
        </div>
        
        <img src="/images/banner/love-3.png" alt="危険な異性のタイプ" class="section-banner">
        <div class="love-new-section hanging-text">
            <p id="fortune-love-dangerous-type"></p>
        </div>
        
        <!-- 人間関係運の新規セクション -->
        <img src="/images/banner/relation-1.png" alt="新しい人間関係" class="section-banner">
        <div class="relationship-new-section hanging-text">
            <p id="fortune-relationship-new-connections"></p>
        </div>
        
        <img src="/images/banner/relation-2.png" alt="課題と解決策" class="section-banner">
        <div class="relationship-new-section hanging-text">
            <p id="fortune-relationship-challenges"></p>
        </div>
        
        <!-- 金運の新規セクション -->
        <img src="/images/banner/money-2.png" alt="金銭トラブル回避" class="section-banner">
        <div class="money-new-section hanging-text">
            <p id="fortune-money-trouble"></p>
        </div>
    </div>
    
    <div id="test-log" class="test-section">
        <h2>実行ログ</h2>
        <pre id="log-content"></pre>
    </div>
    
    <script>
        function log(message, type = 'success') {
            const logEl = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            console.log(message);
        }
        
        async function loadAndTestData() {
            log('データローダーを初期化中...');
            
            if (!window.OtsukisamaDataLoader) {
                log('エラー: OtsukisamaDataLoaderが見つかりません', 'error');
                return false;
            }
            
            const loader = window.OtsukisamaDataLoader;
            log('データを読み込み中...');
            
            const success = await loader.loadAllData();
            if (!success) {
                log('エラー: データの読み込みに失敗しました', 'error');
                return false;
            }
            
            log('データ読み込み完了');
            
            // データ統計を表示
            const statusDiv = document.getElementById('data-status');
            const patternsCount = Object.keys(loader.patternsData).length;
            let newSectionsCount = 0;
            
            for (const key in loader.patternsData) {
                if (loader.patternsData[key].newSections) {
                    newSectionsCount++;
                }
            }
            
            statusDiv.innerHTML = `
                <p class="success">✓ データ読み込み成功</p>
                <p>総パターン数: ${patternsCount}</p>
                <p>新規セクション含有数: ${newSectionsCount}</p>
                <p class="${newSectionsCount === patternsCount ? 'success' : 'warning'}">
                    カバー率: ${((newSectionsCount / patternsCount) * 100).toFixed(1)}%
                </p>
            `;
            
            window.dataLoader = loader;
            return true;
        }
        
        function testPattern(patternId) {
            if (!window.dataLoader) {
                log('エラー: データがまだ読み込まれていません', 'error');
                return;
            }
            
            log(`パターン${patternId}をテスト中...`);
            
            const pattern = window.dataLoader.getPatternFortune(patternId);
            if (!pattern) {
                log(`エラー: パターン${patternId}が見つかりません`, 'error');
                return;
            }
            
            log(`パターン${patternId}: ${pattern.moonPhase} × ${pattern.hiddenPhase}`);
            
            // 新規セクションの存在確認
            if (!pattern.newSections) {
                log('警告: newSectionsが存在しません', 'warning');
                return;
            }
            
            // 恋愛運セクション
            if (pattern.newSections.love) {
                const destinyEl = document.getElementById('fortune-love-destiny-meeting');
                const admirerEl = document.getElementById('fortune-love-admirer-type');
                const dangerousEl = document.getElementById('fortune-love-dangerous-type');
                
                if (destinyEl) destinyEl.textContent = pattern.newSections.love.destinyMeeting || '未設定';
                if (admirerEl) admirerEl.textContent = pattern.newSections.love.admirerType || '未設定';
                if (dangerousEl) dangerousEl.textContent = pattern.newSections.love.dangerousType || '未設定';
                
                log('✓ 恋愛運の新規セクションを更新しました');
            }
            
            // 人間関係運セクション
            if (pattern.newSections.relationship) {
                const connectionsEl = document.getElementById('fortune-relationship-new-connections');
                const challengesEl = document.getElementById('fortune-relationship-challenges');
                
                if (connectionsEl) connectionsEl.textContent = pattern.newSections.relationship.newConnections || '未設定';
                if (challengesEl) challengesEl.textContent = pattern.newSections.relationship.challengesAndSolutions || '未設定';
                
                log('✓ 人間関係運の新規セクションを更新しました');
            }
            
            // 金運セクション
            if (pattern.newSections.money) {
                const troubleEl = document.getElementById('fortune-money-trouble');
                
                if (troubleEl) troubleEl.textContent = pattern.newSections.money.moneyTrouble || '未設定';
                
                log('✓ 金運の新規セクションを更新しました');
            }
            
            // 文字数統計
            let totalChars = 0;
            if (pattern.newSections.love) {
                totalChars += (pattern.newSections.love.destinyMeeting || '').length;
                totalChars += (pattern.newSections.love.admirerType || '').length;
                totalChars += (pattern.newSections.love.dangerousType || '').length;
            }
            if (pattern.newSections.relationship) {
                totalChars += (pattern.newSections.relationship.newConnections || '').length;
                totalChars += (pattern.newSections.relationship.challengesAndSolutions || '').length;
            }
            if (pattern.newSections.money) {
                totalChars += (pattern.newSections.money.moneyTrouble || '').length;
            }
            
            log(`新規セクション合計文字数: ${totalChars}文字`);
        }
        
        function testRandomPattern() {
            const randomId = Math.floor(Math.random() * 64);
            testPattern(randomId);
        }
        
        // ページ読み込み時にデータを読み込む
        window.addEventListener('DOMContentLoaded', async () => {
            log('ページ読み込み完了');
            await loadAndTestData();
            
            // デフォルトでパターン0を表示
            if (window.dataLoader) {
                testPattern(0);
            }
        });
    </script>
    
    <!-- 必要なスクリプトを読み込み -->
    <script src="public/js/otsukisama-data-loader.js"></script>
    
    <!-- CSSスタイルを読み込み -->
    <style>
        /* バナー画像のスタイル */
        .section-banner {
            width: 100%;
            height: auto;
            display: block;
            margin-bottom: -25px;
            position: relative;
            z-index: 1;
        }
        
        /* テキストセクションのスタイル - バナーの下に吊り下がるデザイン */
        .hanging-text {
            margin-top: 0;
            padding: 35px 30px 25px;
            background: linear-gradient(135deg, rgba(20, 10, 50, 0.95), rgba(40, 20, 70, 0.95));
            border-radius: 0 0 20px 20px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-top: none;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            position: relative;
            z-index: 0;
            margin-bottom: 40px;
        }
        
        .love-new-section p,
        .relationship-new-section p,
        .money-new-section p {
            color: #ffffff;
            line-height: 1.8;
            font-size: 16px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            min-height: 50px;
            margin: 0;
        }
    </style>
</body>
</html>